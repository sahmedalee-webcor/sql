create or replace view SCDATAANALYTICS_PROD.DWH.VIEW_FCT_TCC(
	SPRH_BC_REQUESTNO,
	SPRH_CUSTOMER_NUMBER,
	SPRH_CUSTOMER_NAME,
	SPR_DESCRIPTION,
	SPRH_SOURCE,
	SPRH_BC_CUSTOMER_PR_NUMBER,
	SPR_CREATION_DATE,
	SPRH_PR_CREATED_BY,
	SPRH_PR_MODIFIED_BY,
	CSH_BC_COSTINGSHEET_NUMBER,
	CSH_VENDOR_NAME,
	CSH_BC_CUSTOMER_PR_NUMBER,
	CSH_PORT_OF_LOADING,
	CSH_PORT_OF_DISCHARGE,
	CSH_SOURCE,
	CSH_BC_REQUESTNO,
	CSH_NUMBER_OF_CONTAINERS,
	CSH_VENDOR_CODE,
	CSH_CONTAINER_TYPE,
	CSH_COSTINGSHEET_DATE,
	CSH_BC_CUSTOMER_ID,
	CSH_CUSTOMER_NAME,
	CSH_PAYMENT_TERMS_CODE_VENDOR,
	CSH_BC_COSTINGSHEET_STATUS,
	CSH_CS_STAGE,
	CSH_PT_DESCRIPTION,
	VT_SOURCE,
	VT_SUPPLIER_INCOTERMS,
	VT_BC_CUSTOMER_PO_NUMBER,
	VT_NO_OF_CONTAINERS,
	VT_BC_COSTINGSHEET_NUMBER,
	VT_SUPPLIER_ETD,
	VT_CARGO_READY_DATE,
	VT_ACTUAL_ETD,
	VT_ACTUAL_ETA,
	VT_REQUESTED_ETA,
	VT_SHIPPING_LINE,
	VT_BOOKING_REFERENCE_NUMBER,
	VT_VESSEL_NAME,
	VT_DULICENSE_NUMBER,
	VT_DU_EXPIRY_DATE,
	VT_TRACKING_AWB_NUMBER,
	VT_BL_DATE,
	VT_GRN_DATE,
	VT_DC_DELIVERY_DATE,
	VT_VGM_SUBDATE,
	VT_SI_SUB_DATE,
	SL_PTP_LOADINGPORTETD,
	SL_PTP_LOADINGPORTATD,
	SL_PTP_DISCHARGEPORTETA,
	SL_PTP_DISCHARGEPORTATA,
	VT_BL_NUMBER,
	CSH_MODE_OF_SHIPMENT,
	CS_QUANTITY,
	CS_SALES_UOM,
	CS_PURCHASE_UOM,
	CSL_SO_NUMBER,
	CSL_PO_NUMBER,
	CS_ITEM_PO,
	CS_ITEM_SO,
	POH_BC_PURCHASEHEADER_NUMBER,
	POH_VENDOR_INVOICE_NUMBER,
	VENDOR_INVOICE_COUNT,
	POH_BUY_FROM_VENDOR_NUMBER,
	PO_LINE_ITEM_NUMBER,
	POL_QUANTITY,
	PO_LINE_UNIT_OF_MEASURE,
	POL_AMOUNT,
	PO_PT_DESCRIPTION,
	PI_ORDERNO,
	PI_VENDOR_INVOICE_NO,
	PI_PURCHASE_FROM_VENDOR_NUMBER,
	POSTED_INVOICE_H_BC_PI_NUMBER,
	PI_BUY_FROM_VENDOR_NUMBER,
	PI_ITEM_NO,
	PI_LINE_UNIT_OF_MEASURE,
	PI_QUANTITY,
	PI_LINE_AMOUNT_LCY,
	PI_PT_DESCRIPTION,
	BC_ORDER_NUMBER,
	POSTED_SALES_H_BC_SI_NO,
	MIN_SI_POSTING_DATE,
	SI_POSTING_DATE,
	LIST_SI_POSTING_DATE,
	SI_ITEM_NUMBER,
	BC_SI_LINE_AMOUNT,
	BC_SI_LINE_QUANTITY,
	BC_SI_LINE_UNIT_OF_MEASURE,
	SOURCING_OFFICE,
	PPH_VENDOR_NAME,
	POH_VENDOR_NAME,
	PPI_L_FRT_PI_LINE_AMOUNT_LCY,
	PPI_L_INS_PI_LINE_AMOUNT_LCY,
	PSL_FRT_LINE_AMOUNT,
	PSL_INS_LINE_AMOUNT,
	CSH_CS_MARGIN,
	CSH_EQUIPMENT_TYPE,
	CSH_FREIGHT_CURRENCY,
	CSH_FREIGHT_COST,
	CSL_FX_RATE,
	REQUEST_FOR_INSPECTION_FLAG,
	CSL_TOTAL_FOB_COST_USD,
	CSH_PETRAMAR_CHARGES,
	CSH_FREIGHT_PROVIDER,
	CSH_SHIPMENT_COUNTRY_CODE,
	CSL_TOTAL_CI_CIF,
	VT_CUSTOMER_DOC_SENT_DATE,
	VT_CUSTOMER_LC_NUMBER,
	CSH_CUST_NAME,
	VT_BOOKING_DATE,
	BC_CS_SYSTEM_CREATED_BY,
	BC_CS_SYSTEM_MODIFIED_BY,
	VT_CUSTOMER_DOC_RCV_DATE,
	VT_DRAFTAPDATE,
	VT_DISCHARGED_AT_POD,
	SELLING_FOB,
	FINAL_VENDOR_NAME,
	MPR,
	"Vendor Invoice",
	"Vendor Payment Term",
	"No. Of Containers",
	CALC_NUMBER_OF_CONTAINERS,
	PURCHASE_FOB_USD,
	PURCHASE_FOB_CS_VENDOR_USD,
	PURCHASE_FOB_CS_USD,
	CALC_CSH_FREIGHT_COST,
	CSH_TOTAL_FREIGHT_COST,
	CALC_PPL_FRT_LINE_AMT_USD,
	TOTAL_FREIGHT_COST,
	M_CS_TOTAL_FREIGHT_COST_LS_PETRAMAR,
	CI_AMOUNT,
	FINAL_PO_NUMBER,
	INVOICING_STATUS,
	FINAL_VT_SUPPLIER_ETD,
	FINAL_VT_CARGO_READY_DATE,
	FINAL_VT_ACTUAL_ETD,
	FINAL_VT_ACTUAL_ETA,
	TRANSIT_TIME,
	DAYS_BW_ETD_DOCSUB,
	FINAL_VT_SI_SUB_DATE,
	DAYS_BW_DOCSUB_CI,
	FINAL_VT_REQUESTED_ETA,
	FINAL_VT_DU_EXPIRY_DATE,
	"DU LIFE",
	VT_DU_STATUS_ORIG,
	VT_DU_STATUS,
	FINAL_VT_GRN_DATE,
	SPR_ACTIVE_FLAG,
	FINAL_VT_BL_DATE,
	OPERATIONAL_STATUS,
	OPERATIONAL_STATUS_ORDER,
	FINAL_CUSTOMER_NAME,
	DELIVERY_FLAG,
	OPERATIONAL_STATUS_CUSTOMERVIEW,
	OPERATIONAL_STATUS_ORDER_CUSTOMERVIEW,
	ETD_PASSED_2DAYS_NOTSHIPPED_FLAG,
	ETD_PASSED_6_DAYS_INVOICE_NOT_SUBMITTED_FLAG,
	ETA_PASSED_20_DAYS_GRN_NOT_UPDATED_FLAG,
	ETD_PRIOR_1_DAY_PRE_DEPARTURE_FLAG,
	DU_LIFE_FLAG,
	ARRIVING_SOON_FLAG,
	FINAL_VT_CUSTOMER_DOC_SENT_DATE,
	PENDING_CUSTOMER_DOC_12_DAYS_BEFORE_ETA_FLAG,
	PAST_SUPPLIER_ETD_DATE_FLAG,
	PENDING_DU_FLAG,
	FINAL_VT_BOOKING_DATE,
	PENDING_PO_CREATION_FLAG,
	MISSING_REQUESTED_ETA_FLAG,
	ETA_DELAY_DAYS,
	ETA_PERFORMANCE_FLAG,
	FINAL_VT_CUSTOMER_DOC_RCV_DATE,
	FINAL_VT_DRAFTAPDATE,
	CS_MPR_MPO,
	BOOKING_BL,
	ETA_PASSED_1DAY_NOTARRIVED_FLAG,
	CUSTID_SOURCE,
	EXP_LC_UNIQUE_ID,
	EXP_LC_NO,
	EXP_LINK_PFS,
	EXP_LC_CS_ID,
	EXP_LC_TYPE,
	EXP_LC_DOCUMENTARY_CREDIT_NO,
	EXP_LC_DATE_OF_ISSUE,
	EXP_LC_PLACE_OF_EXPIRY,
	EXP_LC_DATE_OF_EXPIRY,
	EXP_LC_ISSUED_BY_ISSUED_TO,
	EXP_LC_CUST_VEND_NAME,
	EXP_LC_CURRENCY,
	EXP_LC_AMOUNT,
	EXP_LC_PAYMENT_TERMS,
	EXP_LC_PAYMENT_TERMS_DESCRIPTION,
	EXP_LC_PRODUCT_DESCRIPTION,
	EXP_LC_CONFIRMATION,
	EXP_LC_DOCUMENT_STATUS,
	EXP_LC_INITIAL_VALUE,
	EXP_LC_SOURCE,
	LC_CUSTOMER_DOC_MISSING_GT12_FLAG,
	LC_NOT_SUBMITTED_TO_FINANCE_FLAG,
	LC_DOC_OPS_STATUS
) as 
WITH SPRH AS(
    SELECT 
        NULLIF(BC_REQUESTNO,'') AS SPRH_BC_REQUESTNO,
        NULLIF(CUSTOMER_NUMBER,'') AS SPRH_CUSTOMER_NUMBER,
        CASE 
        WHEN CBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, LUANDA' THEN 'AA, LUANDA'
        WHEN CBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, CABINDA' THEN 'AA, CABINDA'
        WHEN CBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, LOBITO' THEN 'AA, LOBITO'
        WHEN CBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, NAMIBE' THEN 'AA, NAMIBE'
        ELSE NULLIF(CBC.NAME,'')  
        END AS SPRH_CUSTOMER_NAME,
        NULLIF(PR_DESCRIPTION,'') AS SPRH_PR_DESCRIPTION,
        NULLIF(PRH.SOURCE,'') AS SPRH_SOURCE,
        NULLIF(BC_CUSTOMER_PR_NUMBER,'') AS SPRH_BC_CUSTOMER_PR_NUMBER,
        PR_CREATED_DATE AS SPR_CREATION_DATE,
        PR_CREATED_BY AS SPRH_PR_CREATED_BY,
        PR_MODIFIED_BY AS SPRH_PR_MODIFIED_BY
    from DWH.FCT_PRINPUT_HEADER_BC PRH
        LEFT JOIN DWH.DIM_CUSTOMERS_BC CBC ON 
        PRH.CUSTOMER_NUMBER =CBC.NO AND UPPER(PRH.SOURCE)=UPPER(CBC.SOURCE)
        AND CBC.CURRENT_FLAG=1 AND UPPER(CBC.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) 
    WHERE PRH.current_flag = 1
        AND UPPER(PRH.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --2642 ROWS --2618 rows
),
SPRL AS (
    SELECT 
        NULLIF(BC_REQUESTNO,'') AS SPRL_BC_REQUESTNO,
        NULLIF(ITEM_NUMBER, '') AS SPRL_ITEM_NUMBER,
        NULLIF(ITEM_REFERENCE_NUMBER, '') AS SPRL_ITEM_REFERENCE_NUMBER,
        UNIT_OF_MEASURE AS SPRL_UNIT_OF_MEASURE,
        --NULLIF(ITEM_DESCRIPTION,'') AS SPRL_ITEM_DESCRIPTION,
        SUM(QUANTITY) AS SPRL_QUANTITY,
        SUM(CS_QUANTITY) AS SPRL_CS_QUANITY,
        --MAX(UNIT_OF_MEASURE) AS SPR_UOM,
        --LINE_NUMBER AS SPRL_LINE_NUMBER,
        SOURCE AS SPRL_SOURCE
   --SELECT * 
   FROM DWH.FCT_PRINPUT_LINE_BC PRL
    WHERE current_flag = 1
        AND UPPER(PRL.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
    GROUP BY BC_REQUESTNO,
        NULLIF(ITEM_NUMBER, ''),
        ITEM_REFERENCE_NUMBER,
        SOURCE,
        UNIT_OF_MEASURE
        --SPRL_ITEM_DESCRIPTION
),
SPR AS (
    SELECT DISTINCT *
    FROM SPRH
        LEFT JOIN SPRL ON SPRH.SPRH_BC_REQUESTNO = SPRL.SPRL_BC_REQUESTNO
        AND SPRH.SPRH_SOURCE = SPRL.SPRL_SOURCE
    WHERE NULLIF(SPRL_ITEM_NUMBER, '') IS NOT NULL
) -- SELECT * FROM SPR;--5855 -- 5704-- 5053 (6/10)
--SELECT SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER, COUNT(*) FROM SPR GROUP BY SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER  HAVING COUNT(*)>1;
,
CSHR AS(
    SELECT DISTINCT         
        CSH.BC_COSTINGSHEET_NUMBER AS CSH_BC_COSTINGSHEET_NUMBER,
        VENDBC.NAME AS CSH_VENDOR_NAME,
        --CSH.VENDOR_NAME,
        --PROCESS_FLAG,
        BC_CUSTOMER_PR_NUMBER AS CSH_BC_CUSTOMER_PR_NUMBER,
        PORT_OF_LOADING AS CSH_PORT_OF_LOADING,
        PORT_OF_DISCHARGE AS CSH_PORT_OF_DISCHARGE,
        CSH.SOURCE AS CSH_SOURCE,
        BC_REQUEST_NUMBER AS CSH_BC_REQUESTNO,
        CSH.NUMBER_OF_CONTAINERS AS CSH_NUMBER_OF_CONTAINERS ,
        CSH.VENDOR_CODE AS CSH_VENDOR_CODE,
        CONTAINER_TYPE AS CSH_CONTAINER_TYPE,
        costingsheet_date AS CSH_costingsheet_date,
        BC_CUSTOMER_ID AS CSH_BC_CUSTOMER_ID,
        NULLIF(CUSTOMER_NAME,'') AS CSH_CUSTOMER_NAME,
        CASE 
        WHEN CUSTBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, LUANDA' THEN 'AA, LUANDA'
        WHEN CUSTBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, CABINDA' THEN 'AA, CABINDA'
        WHEN CUSTBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, LOBITO' THEN 'AA, LOBITO'
        WHEN CUSTBC.NAME = 'ANGOALISSAR COMERCIO E INDUSTRIA, LDA, NAMIBE' THEN 'AA, NAMIBE'
        ELSE CUSTBC.NAME 
        END AS CSH_CUST_NAME,
        PAYMENT_TERMS_CODE_VENDOR AS CSH_PAYMENT_TERMS_CODE_VENDOR,
        BC_COSTINGSHEET_STATUS AS CSH_BC_COSTINGSHEET_STATUS,
        CS_STAGE AS CSH_CS_STAGE,
        PT.DESCRIPTION AS CSH_PT_DESCRIPTION,
        CS_MARGIN AS CSH_CS_MARGIN,
        CASE WHEN EQUIPMENT_TYPE IN ('DV', 'Dry') THEN 'Dry'
        WHEN EQUIPMENT_TYPE IN ('RF', 'Reef') THEN 'Reefer'
        WHEN EQUIPMENT_TYPE IN ('Iso', 'Isotank') THEN 'Isotank'
        WHEN EQUIPMENT_TYPE IS NULL OR EQUIPMENT_TYPE='' THEN NULL
        ELSE EQUIPMENT_TYPE END     
         AS CSH_EQUIPMENT_TYPE,
        NULLIF(CSH.FREIGHT_CURRENCY,'') AS CSH_FREIGHT_CURRENCY,
        CSH.FREIGHT_COST AS CSH_FREIGHT_COST,   
        PETRAMAR_CHARGES AS CSH_PETRAMAR_CHARGES,
        FREIGHT_PROVIDER AS CSH_FREIGHT_PROVIDER,
        SHIPMENT_COUNTRY_CODE AS CSH_SHIPMENT_COUNTRY_CODE,
        MODE_OF_SHIPMENT AS CSH_MODE_OF_SHIPMENT,
        BC_CS_SYSTEM_CREATED_BY,
        BC_CS_SYSTEM_MODIFIED_BY
    FROM DWH.FCT_COSTINGSHEET_HEADER_BC CSH --3272
        LEFT JOIN DWH.DIM_Vendors_BC VENDBC ON CSH.VENDOR_CODE = VENDBC.NO
        AND UPPER(CSH.SOURCE) = UPPER(VENDBC.SOURCE)
        AND VENDBC.CURRENT_FLAG = 1
        AND UPPER(VENDBC.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
        LEFT JOIN DWH.DIM_PAYMENTTERMS_BC PT ON CSH.PAYMENT_TERMS_CODE_VENDOR = PT.CODE
        AND UPPER(CSH.SOURCE) = UPPER(PT.SOURCE)
        AND PT.CURRENT_FLAG = 1
        AND UPPER(PT.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
        LEFT JOIN DWH.DIM_CUSTOMERS_BC CUSTBC ON CSH.BC_CUSTOMER_ID = CUSTBC.NO
        AND UPPER(CSH.SOURCE) = UPPER(CUSTBC.SOURCE)
        AND CUSTBC.CURRENT_FLAG = 1
        AND UPPER(CUSTBC.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
    WHERE CSH.current_flag = 1
        AND UPPER(CSH.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
      --  AND CSH.cs_stage <> 'Cancelled' --3233 rows
        --and YEAR(costingsheet_date) > 2023
        -- AND CSH.BC_CUSTOMER_ID <> 'C00015'
        --AND CSH.BC_CUSTOMER_ID IN ('C00001', 'C00002', 'C00003', 'C00004') --
         --and CSH.BC_COSTINGSHEET_NUMBER in ('CS-WE01960')
        --('CS-WE01060','CS-WE01649','CS-WE00966')
),
CSL AS (
    SELECT BC_COSTINGSHEET_NUMBER AS CSL_BC_COSTINGSHEET_NUMBER,
        --BC_COSTINGSHEET_LINENUMBER AS CSL_BC_COSTINGSHEET_LINENUMBER,
        BC_COSTINGSHEET_ITEM_NUMBER AS CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        --BC_COSTINGSHEET_ITEM_REFERENCE_NUMBER AS CSL_BC_COSTINGSHEET_ITEM_REFERENCE_NUMBER,
        CSL.SOURCE AS CSL_SOURCE,
        NULLIF(SO_NUMBER, '') AS CSL_SO_NUMBER,
        NULLIF(PO_NUMBER, '') AS CSL_PO_NUMBER,
        SUM(BC_COSTINGSHEET_ITEM_QUANTITY) AS CSL_BC_COSTINGSHEET_ITEM_QUANTITY,
        MAX(BC_COSTINGSHEET_SALES_UOM) AS CSL_BC_COSTINGSHEET_SALES_UOM,
        MAX(BC_COSTINGSHEET_PURCHASE_UOM) AS CSL_BC_COSTINGSHEET_PURCHASE_UOM,
        AVG(CSL.FX_RATE) AS CSL_FX_RATE,
        SUM(CSL.TOTAL_FOB_COST_LCY) AS CSL_TOTAL_FOB_COST_USD,
        SUM(CIF_PRICE_UNIT * BC_COSTINGSHEET_ITEM_QUANTITY)  AS CSL_TOTAL_CI_CIF 
    FROM DWH.FCT_COSTINGSHEET_LINE_BC CSL
    WHERE CURRENT_FLAG = 1
        AND UPPER(CSL.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
        AND TO_VARCHAR(BC_COSTINGSHEET_ITEM_NUMBER) NOT IN ('999998', '999999')
    GROUP BY 
        BC_COSTINGSHEET_NUMBER,
        BC_COSTINGSHEET_ITEM_NUMBER,
        SOURCE,
        SO_NUMBER,
        PO_NUMBER
        
),
CS AS (
    SELECT *,
       CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) AS CS_ITEM_PO,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_SO_NUMBER, '')
        ) AS CS_ITEM_SO
    FROM CSHR
        LEFT JOIN CSL ON CSHR.CSH_BC_COSTINGSHEET_NUMBER = CSL.CSL_BC_COSTINGSHEET_NUMBER
        AND UPPER(CSHR.CSH_SOURCE) = UPPER(CSL.CSL_SOURCE)
      --WHERE CSH_CS_STAGE <> 'Cancelled'
)  --SELECT * FROM CS ;--where CSH_BC_COSTINGSHEET_NUMBER in ('CS-WE01311') ; -- 6321 -6337 rows
--SELECT CSL_BC_COSTINGSHEET_NUMBER, COUNT(DISTINCT CSL_SO_NUMBER) FROM CS GROUP BY  CSL_BC_COSTINGSHEET_NUMBER HAVING COUNT(DISTINCT CSL_SO_NUMBER)>1;
,
CS_SPRH AS (
    SELECT  *
     
    FROM CSHR
        LEFT JOIN SPRH ON CSH_BC_REQUESTNO = SPRH_BC_REQUESTNO 
        --AND SPRL_ITEM_NUMBER = CSL_BC_COSTINGSHEET_ITEM_NUMBER --AND SPRL_LINE_NUMBER = CSL_BC_COSTINGSHEET_LINENUMBER
        AND SPRH_SOURCE = CSH_SOURCE
) --SELECT * FROM CS_SPRH; -- 3448 rows --3356 rows
,
SPR_CS_SING_ITEM_PO AS (
    SELECT 
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_PO_NUMBER,
        --CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
           --IFNULL(CSL_SO_NUMBER,'')
        ) AS CS_ITEM_PO,
        --SPRL_LINE_NUMBER,
        COUNT(*)
    FROM CS
    GROUP BY 
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_PO_NUMBER,
        --CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
            --CSL_SO_NUMBER
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1
) --SELECT * FROM SPR_CS_SING_ITEM_PO; -- 6307 rows  14 rows with issues
--SELECT SPRH_BC_REQUESTNO,CS_ITEM_PO, COUNT(*) FROM SPR_CS_SING_ITEM_PO GROUP BY SPRH_BC_REQUESTNO,CS_ITEM_PO HAVING COUNT(*) >1 ;
,SPR_CS_SING_NONORA_ITEM_SO AS 
    (
    SELECT --DISTINCT
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_SO_NUMBER, '')
        ) AS CS_ITEM_SO,
        --SPRL_LINE_NUMBER,
        COUNT(DISTINCT CS_ITEM_SO)
    FROM CS --WHERE SPRL_ITEM_NUMBER <> '100501'
    GROUP BY 
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_SO_NUMBER, '')
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(DISTINCT CS_ITEM_SO) > 1
) 

--SELECT * FROM SPR_CS_SING_NONORA_ITEM_SO;-- 4840 rows -- 4973 rows
,
SPR_CS_MULTI_ITEM AS (
    SELECT 
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --SPRL_LINE_NUMBER, 
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) AS CS_ITEM_PO,
        --CSL_SO_NUMBER,
        COUNT(*)
    FROM CS
    GROUP BY 
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1
) --SELECT * FROM SPR_CS_MULTI_ITEM;
-- select BC_COSTINGSHEET_NUMBER,
--     count(TEST_CSHR)
-- from cshr
-- group by BC_COSTINGSHEET_NUMBER
-- having count(TEST_CSHR) > 1

,SPR_CS_MULTI_SO AS 
    (
    SELECT 
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_SO_NUMBER, '')
        ) AS CS_ITEM_SO,
        --SPRL_LINE_NUMBER,
        COUNT(*)
    FROM CS --WHERE SPRL_ITEM_NUMBER <> '100501'
    GROUP BY 
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            CSL_BC_COSTINGSHEET_ITEM_NUMBER,
            IFNULL(CSL_SO_NUMBER, '')
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1
) 
--SELECT * FROM SPR_CS_MULTI_SO; -- 190 rows
, CFF AS
    ( 
    (
      WITH CF1 AS
      (
            SELECT  TRIM(ST_NAME) AS ST_NAME
                   ,MAX(MBLNUMBER) AS MBLNUMBER
                   ,MAX(BOOKINGNUMBER) AS BOOKINGNUMBER
                   ,MIN(CONTAINERTYPE) AS CONTAINERTYPE
                   ,MIN(CF_TOOL_STATUS) AS CF_TOOL_STATUS
                   ,MAX(CARRIERSCAC) AS CARRIERSCAC
                   ,MAX(SL_PTP_CARRIER) AS SL_PTP_CARRIER
                   ,MAX(SL_PTP_LOADINGPORTETD) AS SL_PTP_LOADINGPORTETD
                   ,MAX(SL_PTP_LOADINGPORTATD) AS SL_PTP_LOADINGPORTATD
                   ,MAX(SL_PTP_DISCHARGEPORTETA) AS SL_PTP_DISCHARGEPORTETA
                   ,MAX(SL_PTP_DISCHARGEPORTATA) AS SL_PTP_DISCHARGEPORTATA
            FROM DWH.FCT_CARGOES_FLOW
            WHERE CURRENT_FLAG = 1
            AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CONTAINERNUMBER, CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY TRIM(ST_NAME), CONTAINERNUMBER, CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC) AS RankDate FROM DWH.FCT_CARGOES_FLOW A WHERE CURRENT_FLAG = 1 
        
        AND EXISTS (
            SELECT *
            FROM (
                    SELECT TRIM(OPS_PO_NUMBER) AS OPS_PO_NUMBER,
                        BOOKING_NUMBER,
                        BL_NUMBER
                    FROM DWH.FCT_MAPOPS_SWORD
                    WHERE CURRENT_FLAG = 1
                        AND OPS_PO_NUMBER IS NOT NULL AND SOURCE_NAME='SWORD'
                    UNION
                    SELECT CASE WHEN VT.BC_Customer_PO_Number IN ('','TBA','PENDING','**','....') THEN trim(PS.SI_EXTERNAL_DOCUMENT_NUMBER)  ELSE trim(VT.BC_Customer_PO_Number) END AS CUSTOMER_PO_NUMBER,
                        BOOKING_REFERENCE_NUMBER,
                        BL_NUMBER
                    FROM DWH.FCT_VESSEL_TRACKING_BC VT
                     LEFT JOIN DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC PS
                        ON VT.BC_PROFORMA_NUMBER = PS.BC_ORDER_NUMBER AND 
                    UPPER(VT.SOURCE)=UPPER(PS.SOURCE)
                    AND PS.CURRENT_FLAG = 1 AND UPPER(PS.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                    WHERE VT.CURRENT_FLAG = 1
                        AND BC_CUSTOMER_PO_NUMBER IS NOT NULL AND VT.SOURCE IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                ) B
            WHERE A.ST_NAME = B.OPS_PO_NUMBER
                AND EQUAL_NULL(COALESCE(BOOKINGNUMBER,''), COALESCE(BOOKING_NUMBER,''))
                AND EQUAL_NULL(COALESCE(MBLNUMBER,''), COALESCE(BL_NUMBER,''))  )) WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
            AND ST_NAME IS NOT NULL
            AND ST_NAME != 'TBA'
            GROUP BY  TRIM(ST_NAME)
      ), CF2 AS
      (
            SELECT  DISTINCT *
            FROM
            (
                  SELECT  TRIM(ST_NAME)                                                                                           AS CFPO_NUMBER
                         ,FIRST_VALUE(SL_PTP_LOADINGPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)       AS FIRST_SL_PTP_LOADINGPORT
                         ,FIRST_VALUE(SL_PTP_LOADINGPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_SL_PTP_LOADINGPORT_CODE
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)     AS FIRST_SL_PTP_DISCHARGEPORT
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_DISCHARGEPORT_CODE
                         ,FIRST_VALUE(DISCHARGE_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)AS FIRST_DISCHARGE_PORT_LATITUDE
                         ,FIRST_VALUE(DISCHARGE_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)AS FIRST_DISCHARGE_PORT_LONGITUDE
                         ,FIRST_VALUE(LOADING_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)    AS FIRST_LOADING_PORT_LATITUDE
                         ,FIRST_VALUE(LOADING_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_LOADING_PORT_LONGITUDE
                         ,FIRST_VALUE(SL_PTP_CURRENTVESSELNAME) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_CURRENTVESSELNAME
                  FROM DWH.FCT_CARGOES_FLOW
                  WHERE CURRENT_FLAG = 1
                  AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CONTAINERNUMBER, CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY TRIM(ST_NAME), CONTAINERNUMBER, CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC) AS RankDate FROM DWH.FCT_CARGOES_FLOW A WHERE CURRENT_FLAG = 1 
        
        AND EXISTS (
            SELECT *
            FROM (
                    SELECT TRIM(OPS_PO_NUMBER) AS OPS_PO_NUMBER,
                        BOOKING_NUMBER,
                        BL_NUMBER
                    FROM DWH.FCT_MAPOPS_SWORD
                    WHERE CURRENT_FLAG = 1
                        AND OPS_PO_NUMBER IS NOT NULL AND SOURCE_NAME='SWORD'
                    UNION
                    SELECT CASE WHEN VT.BC_Customer_PO_Number IN ('','TBA','PENDING','**','....') THEN trim(PS.SI_EXTERNAL_DOCUMENT_NUMBER)  ELSE trim(VT.BC_Customer_PO_Number) END AS CUSTOMER_PO_NUMBER,
                        BOOKING_REFERENCE_NUMBER,
                        BL_NUMBER
                    FROM DWH.FCT_VESSEL_TRACKING_BC VT
                     LEFT JOIN DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC PS
                        ON VT.BC_PROFORMA_NUMBER = PS.BC_ORDER_NUMBER AND 
                    UPPER(VT.SOURCE)=UPPER(PS.SOURCE)
                    AND PS.CURRENT_FLAG = 1 AND UPPER(PS.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                    WHERE VT.CURRENT_FLAG = 1
                        AND BC_CUSTOMER_PO_NUMBER IS NOT NULL AND VT.SOURCE IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                ) B
            WHERE A.ST_NAME = B.OPS_PO_NUMBER
                AND EQUAL_NULL(COALESCE(BOOKINGNUMBER,''), COALESCE(BOOKING_NUMBER,''))
                AND EQUAL_NULL(COALESCE(MBLNUMBER,''), COALESCE(BL_NUMBER,'')) )) WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
                  AND ST_NAME IS NOT NULL
                  AND ST_NAME != 'TBA' 
            )
      )
      SELECT  CF1.*
             ,CF2.*
      FROM CF1
      JOIN CF2
      ON TRIM(CF1.ST_NAME) = TRIM(CF2.CFPO_NUMBER))
     /* UNION (
      WITH CFA1 AS
      (
            SELECT  TRIM(ST_NAME) AS ST_NAME
                   ,MAX(MBLNUMBER)
                   ,MAX(BOOKINGNUMBER)
                   ,MIN('dummy_ContainerType')
                   ,MIN(CF_TOOL_STATUS)
                   ,MAX('dummy_CarrierSCAC')
                   ,MAX(SL_PTP_CARRIER)
                   ,MAX(SL_PTP_LOADINGPORTETD)
                   ,MAX(SL_PTP_LOADINGPORTATD)
                   ,MAX(SL_PTP_DISCHARGEPORTETA)
                   ,MAX(SL_PTP_DISCHARGEPORTATA)
            FROM DWH.FCT_CARGOES_FLOW_AIR
            WHERE CURRENT_FLAG = 1
            AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY TRIM(ST_NAME), CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC ) AS RankDate FROM DWH.FCT_CARGOES_FLOW_AIR A WHERE CURRENT_FLAG = 1 
        
        AND EXISTS (
            SELECT *
            FROM (
                    SELECT TRIM(OPS_PO_NUMBER) AS OPS_PO_NUMBER,
                        CLEANSED_BL_AWB_NUMBER
                    FROM DWH.FCT_MAPOPS_SWORD
                    WHERE CURRENT_FLAG = 1
                        AND OPS_PO_NUMBER IS NOT NULL AND SOURCE_NAME='SWORD'
                    UNION
                    SELECT CASE WHEN VT.BC_Customer_PO_Number IN ('','TBA','PENDING','**','....') THEN trim(PS.SI_EXTERNAL_DOCUMENT_NUMBER)  ELSE trim(VT.BC_Customer_PO_Number) END AS CUSTOMER_PO_NUMBER,
                        CLEANSED_BL_AWB_NUMBER
                    FROM DWH.FCT_VESSEL_TRACKING_BC VT
                     LEFT JOIN DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC PS
                        ON VT.BC_PROFORMA_NUMBER = PS.BC_ORDER_NUMBER AND 
                    UPPER(VT.SOURCE)=UPPER(PS.SOURCE)
                    AND PS.CURRENT_FLAG = 1 AND UPPER(PS.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                    WHERE VT.CURRENT_FLAG = 1
                        AND BC_CUSTOMER_PO_NUMBER IS NOT NULL AND VT.SOURCE IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                ) B
            WHERE A.ST_NAME = B.OPS_PO_NUMBER
                  AND EQUAL_NULL(COALESCE(MBLNUMBER,''), COALESCE(CLEANSED_BL_AWB_NUMBER,'')) )
        
        
        
        
        
        ) WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
            AND ST_NAME IS NOT NULL
            AND ST_NAME != 'TBA'
            GROUP BY  TRIM(ST_NAME)
      ), CFA2 AS
(
            SELECT  DISTINCT *
            FROM
            (
                  SELECT  TRIM(ST_NAME)                                                                                           AS CFPO_NUMBER
                         ,FIRST_VALUE(SL_PTP_LOADINGPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)       AS FIRST_SL_PTP_LOADINGPORT
                         ,FIRST_VALUE(SL_PTP_LOADINGPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_SL_PTP_LOADINGPORT_CODE
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)     AS FIRST_SL_PTP_DISCHARGEPORT
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_DISCHARGEPORT_CODE
                         ,FIRST_VALUE(DISCHARGE_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)  AS FIRST_DISCHARGE_PORT_LATITUDE
                         ,FIRST_VALUE(DISCHARGE_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_DISCHARGE_PORT_LONGITUDE
                         ,FIRST_VALUE(LOADING_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)    AS FIRST_LOADING_PORT_LATITUDE
                         ,FIRST_VALUE(LOADING_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_LOADING_PORT_LONGITUDE
                         ,FIRST_VALUE(SL_PTP_CURRENTVESSELNAME) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_CURRENTVESSELNAME
                  FROM DWH.FCT_CARGOES_FLOW_AIR
                  WHERE CURRENT_FLAG = 1
                  AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY ST_NAME, CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC ) AS RankDate FROM DWH.FCT_CARGOES_FLOW_AIR A WHERE CURRENT_FLAG = 1  
             AND EXISTS (
            SELECT *
            FROM (
                    SELECT TRIM(OPS_PO_NUMBER) AS OPS_PO_NUMBER,
                        CLEANSED_BL_AWB_NUMBER
                    FROM DWH.FCT_MAPOPS_SWORD
                    WHERE CURRENT_FLAG = 1
                        AND OPS_PO_NUMBER IS NOT NULL AND SOURCE_NAME='SWORD'
                    UNION
                    SELECT CASE WHEN VT.BC_Customer_PO_Number IN ('','TBA','PENDING','**','....') THEN trim(PS.SI_EXTERNAL_DOCUMENT_NUMBER)  ELSE trim(VT.BC_Customer_PO_Number) END AS CUSTOMER_PO_NUMBER,
                        CLEANSED_BL_AWB_NUMBER
                    FROM DWH.FCT_VESSEL_TRACKING_BC VT
                     LEFT JOIN DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC PS
                        ON VT.BC_PROFORMA_NUMBER = PS.BC_ORDER_NUMBER AND 
                    UPPER(VT.SOURCE)=UPPER(PS.SOURCE)
                    AND PS.CURRENT_FLAG = 1 AND UPPER(PS.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                    WHERE VT.CURRENT_FLAG = 1
                        AND BC_CUSTOMER_PO_NUMBER IS NOT NULL AND VT.SOURCE IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                ) B
            WHERE A.ST_NAME = B.OPS_PO_NUMBER
                  AND EQUAL_NULL(COALESCE(MBLNUMBER,''), COALESCE(CLEANSED_BL_AWB_NUMBER,'')) )
            
            
            
            
            
            
            
            ) 
            
            
            
            
            
            
            
            
            WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
                  AND ST_NAME IS NOT NULL
                  AND ST_NAME != 'TBA' 
            )
      )
      SELECT  CFA1.*
             ,CFA2.*
      FROM CFA1
      JOIN CFA2
      ON TRIM(CFA1.ST_NAME) = TRIM(CFA2.CFPO_NUMBER))*/
      UNION (
      WITH CFBK AS
      (
            SELECT  TRIM(ST_NAME) AS ST_NAME
                   ,MAX(MBLNUMBER)
                   ,MAX(BOOKINGNUMBER)
                   ,MIN(CONTAINERTYPE)
                   ,MIN(CF_TOOL_STATUS)
                   ,MAX(CARRIERSCAC)
                   ,MAX(SL_PTP_CARRIER)
                   ,MAX(SL_PTP_LOADINGPORTETD)
                   ,MAX(SL_PTP_LOADINGPORTATD)
                   ,MAX(SL_PTP_DISCHARGEPORTETA)
                   ,MAX(SL_PTP_DISCHARGEPORTATA)
            FROM DWH.FCT_CARGOES_FLOW_BULK
            WHERE CURRENT_FLAG = 1
            AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CONTAINERNUMBER, CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY TRIM(ST_NAME), CONTAINERNUMBER, CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC) AS RankDate FROM DWH.FCT_CARGOES_FLOW_BULK WHERE CURRENT_FLAG = 1  ) WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
            AND ST_NAME IS NOT NULL
            AND ST_NAME != 'TBA'
            GROUP BY  TRIM(ST_NAME)
      ), CFBK2 AS
      (
            SELECT  DISTINCT *
            FROM
            (
                  SELECT  TRIM(ST_NAME)                                                                                           AS CFPO_NUMBER
                         ,FIRST_VALUE(SL_PTP_LOADINGPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)       AS FIRST_SL_PTP_LOADINGPORT
                         ,FIRST_VALUE(SL_PTP_LOADINGPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_SL_PTP_LOADINGPORT_CODE
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORT) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)     AS FIRST_SL_PTP_DISCHARGEPORT
                         ,FIRST_VALUE(SL_PTP_DISCHARGEPORTCODE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_DISCHARGEPORT_CODE
                         ,FIRST_VALUE(DISCHARGE_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)AS FIRST_DISCHARGE_PORT_LATITUDE
                         ,FIRST_VALUE(DISCHARGE_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)AS FIRST_DISCHARGE_PORT_LONGITUDE
                         ,FIRST_VALUE(LOADING_PORT_LATITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)    AS FIRST_LOADING_PORT_LATITUDE
                         ,FIRST_VALUE(LOADING_PORT_LONGITUDE) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC)   AS FIRST_LOADING_PORT_LONGITUDE
                         ,FIRST_VALUE(SL_PTP_CURRENTVESSELNAME) OVER (PARTITION BY TRIM(ST_NAME) ORDER BY TRACKINGUPDATEDAT DESC) AS FIRST_SL_PTP_CURRENTVESSELNAME
                  FROM DWH.FCT_CARGOES_FLOW_BULK
                  WHERE CURRENT_FLAG = 1
                  AND CFTOOLSHIPMENTNUMBER IN ( SELECT CFTOOLSHIPMENTNUMBER FROM  ( SELECT TRIM(ST_NAME), CONTAINERNUMBER, CFTOOLSHIPMENTNUMBER, MBLNUMBER, BOOKINGNUMBER, CF_TOOL_STATUS, CARGOESFLOWSHIPMENTCREATEDAT , ROW_NUMBER() OVER (PARTITION BY TRIM(ST_NAME), CONTAINERNUMBER, CF_TOOL_STATUS ORDER BY CARGOESFLOWSHIPMENTCREATEDAT ASC ) AS RankDate FROM DWH.FCT_CARGOES_FLOW_BULK WHERE CURRENT_FLAG = 1  ) WHERE CF_TOOL_STATUS IN ('ACTIVE', 'COMPLETED') AND RankDate = 1)
                  AND ST_NAME IS NOT NULL
                  AND ST_NAME != 'TBA' 
            )
      )
      SELECT  CFBK.*
             ,CFBK2.*
      FROM CFBK
      JOIN CFBK2
      ON TRIM(CFBK.ST_NAME) = TRIM(CFBK2.CFPO_NUMBER))
)
    --SELECT * FROM CFF;
,

VT AS (
    SELECT DISTINCT 
            VTBC.SOURCE AS VT_SOURCE,
            SUPPLIER_INCOTERMS AS VT_SUPPLIER_INCOTERMS,
            (
                CASE
                    WHEN VTBC.BC_Customer_PO_Number IN ('', 'TBA', 'PENDING', '**', '....') THEN PS.SI_EXTERNAL_DOCUMENT_NUMBER
                    ELSE VTBC.BC_Customer_PO_Number
                END
            ) AS VT_BC_CUSTOMER_PO_NUMBER,
            NO_OF_CONTAINERS AS VT_NO_OF_CONTAINERS ,
            BC_COSTINGSHEET_NUMBER AS VT_BC_COSTINGSHEET_NUMBER,
            SUPPLIER_ETD AS VT_SUPPLIER_ETD,
            CARGO_READY_DATE AS VT_CARGO_READY_DATE,
            ACTUAL_ETD AS VT_ACTUAL_ETD,
            ACTUAL_ETA AS VT_ACTUAL_ETA,
            REQUESTED_ETA AS VT_REQUESTED_ETA,
            SHIPPING_LINE AS VT_SHIPPING_LINE,
            NULLIF(BOOKING_REFERENCE_NUMBER,'') AS VT_BOOKING_REFERENCE_NUMBER,
            VESSEL_NAME AS VT_VESSEL_NAME,
            DULICENSE_NUMBER AS VT_DULICENSE_NUMBER,

            DU_EXPIRY_DATE AS VT_DU_EXPIRY_DATE,
            TRACKING_AWB_NUMBER AS VT_TRACKING_AWB_NUMBER,
            VGM_SUB_DATE - ACTUAL_ETD AS COLUMN1,
            VGM_SUB_DATE AS VT_VGM_SUBDATE,
            SI_SUB_DATE AS VT_SI_SUB_DATE,
             --SI_SUB_DATE - ACTUAL_ETD AS VT_DAYS_BW_ETD_DOCSENT,
            -- INVOICE_DATE - VGM_SUB_DATE AS COLUMN2,
            BL_DATE AS VT_BL_DATE,
            GRN_DATE AS VT_GRN_DATE,
            DC_DELIVERY_DATE AS VT_DC_DELIVERY_DATE,
            BL_NUMBER AS VT_BL_NUMBER,
            CFF.SL_PTP_LOADINGPORTETD,
              CFF.SL_PTP_LOADINGPORTATD,
              CFF.SL_PTP_DISCHARGEPORTETA,
              CFF.SL_PTP_DISCHARGEPORTATA,
            CASE WHEN REQUEST_FOR_INSPECTION_FLAG = TRUE THEN 'Yes'
                WHEN REQUEST_FOR_INSPECTION_FLAG = FALSE THEN 'No'
                ELSE REQUEST_FOR_INSPECTION_FLAG  END AS  REQUEST_FOR_INSPECTION_FLAG,
            CASE
            WHEN CUSTOMER_DOC_SENT_DATE NOT IN ('1900-01-01', '0001-01-01') THEN CUSTOMER_DOC_SENT_DATE
            ELSE NULL END AS VT_CUSTOMER_DOC_SENT_DATE,
            NULLIF(CUSTOMER_LC_NUMBER,'') AS VT_CUSTOMER_LC_NUMBER,
            DATE(BOOKING_DATE) AS VT_BOOKING_DATE,
            CUSTOMER_DOC_RCV_DATE AS VT_CUSTOMER_DOC_RCV_DATE,
            DRAFTAPDATE AS VT_DRAFTAPDATE,
            CASE WHEN DISCHARGED_AT_POD = true THEN 'Yes'
                WHEN DISCHARGED_AT_POD = false THEN 'No'
                ELSE DISCHARGED_AT_POD  END
             AS VT_DISCHARGED_AT_POD
                        -- ,CASE WHEN (CUSTOMER_DOC_SENT_DATE IS NOT NULL OR CUSTOMER_DOC_SENT_DATE <> '') AND (INVOICE_DATE IS NULL OR INVOICE_DATE = '' OR INVOICE_DATE IN ('1900-01-01','0001-01-01'))
            -- THEN 'Pending for Invoice'
            -- ELSE 'Invoiced' 
            -- END AS Invoicing_status
            FROM DWH.FCT_VESSEL_TRACKING_BC VTBC
                    LEFT JOIN DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC PS ON VTBC.BC_PROFORMA_NUMBER = PS.BC_ORDER_NUMBER
                    AND UPPER(VTBC.SOURCE) = UPPER(PS.SOURCE)
                    AND PS.CURRENT_FLAG = 1
                    AND UPPER(PS.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                    LEFT JOIN CFF
                    ON VTBC.BC_Customer_PO_Number = TRIM(CFF.ST_NAME)
            where --BOOKING_REFERENCE_NUMBER <> '' 
                VTBC.current_flag = 1
                AND UPPER(VTBC.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) 
               -- AND VT_BC_COSTINGSHEET_NUMBER = ''--2492 --3303 rows
        )
        --SELECT * FROM VT; --- 3330 rows
        ,
        SPR_CS_VT AS (
            SELECT *
            FROM CS_SPRH
                LEFT JOIN VT ON CSH_BC_COSTINGSHEET_NUMBER = VT_BC_COSTINGSHEET_NUMBER
                AND UPPER(CSH_SOURCE) = UPPER(VT_SOURCE)
        ) --SELECT * FROM SPR_CS_VT; -- 3348 rows -- 3356 rows
,
        PO_H_BC AS (
            SELECT DISTINCT 
                BC_PURCHASEHEADER_NUMBER AS POH_BC_PURCHASEHEADER_NUMBER,
                POH.SOURCE AS POH_SOURCE,
                VENDOR_INVOICE_NUMBER AS POH_VENDOR_INVOICE_NUMBER,
                COALESCE(
                    NULLIF(COSTINGSHEET_CODE, ''),
                    COSTINGSHEET_NUMBER
                ) AS POH_FINAL_COSTING_SHEET_CODE,
                POH.CURRENT_FLAG AS POH_CURRENT_FLAG,
                POH.PAYMENT_TERMS_CODE AS POH_PAYMENT_TERMS_CODE,
                BUY_FROM_VENDOR_NUMBER AS POH_BUY_FROM_VENDOR_NUMBER,
                NAME AS POH_VENDOR_NAME
            FROM DWH.FCT_PO_HEADER_BC POH
            LEFT JOIN DWH.DIM_Vendors_BC VENDBC ON POH.BUY_FROM_VENDOR_NUMBER = VENDBC.NO
            AND UPPER(POH.SOURCE) = UPPER(VENDBC.SOURCE)
            AND VENDBC.CURRENT_FLAG = 1
            WHERE POH.CURRENT_FLAG = 1
                AND UPPER(POH.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --8110 -- 8157 rows
        ),
        PO_L_BC AS(
            SELECT SOURCE AS POL_SOURCE,
                BC_PURCHASEHEADER_NUMBER AS POL_BC_PURCHASEHEADER_NUMBER,
                PO_LINE_DOCUMENT_TYPE AS POL_DOCUMENT_TYPE,
                CURRENT_FLAG AS POL_CURRENT_FLAG,
                PO_LINE_ITEM_NUMBER,
                PO_LINE_QUANTITY AS POL_QUANTITY,
                PO_LINE_UNIT_OF_MEASURE,
                PO_LINE_AMOUNT AS POL_AMOUNT,
                --PO_LINE_LINEAMOUNT,
                PO_LINE_LINENO
                
            FROM DWH.FCT_PO_LINE_BC
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --8620
        ),
        PO AS (
            SELECT PO_H_BC.POH_BC_PURCHASEHEADER_NUMBER,
                POH_SOURCE,
                --POH_VENDOR_INVOICE_NUMBER,
                LISTAGG( DISTINCT POH_VENDOR_INVOICE_NUMBER , ' | ' ) WITHIN GROUP (ORDER BY POH_VENDOR_INVOICE_NUMBER)
                --WITHIN GROUP ( ORDER BY POH_BC_PURCHASEHEADER_NUMBER)
                AS POH_VENDOR_INVOICE_NUMBER, -- 
                COUNT (DISTINCT POH_VENDOR_INVOICE_NUMBER) AS VENDOR_INVOICE_COUNT,
                POH_FINAL_COSTING_SHEET_CODE,
                --POH_BUY_FROM_VENDOR_NUMBER,
                --PO_H_BC.POH_CURRENT_FLAG,
                --POH_PAYMENT_TERMS_CODE,
                LISTAGG ( DISTINCT POH_BUY_FROM_VENDOR_NUMBER, ' | ' ) WITHIN GROUP (ORDER BY POH_BUY_FROM_VENDOR_NUMBER)
                -- WITHIN GROUP ( ORDER BY POH_BC_PURCHASEHEADER_NUMBER)
                AS POH_BUY_FROM_VENDOR_NUMBER, --WITHIN GROUP POH_BC_PURCHASEHEADER_NUMBER
                LISTAGG(DISTINCT POH_VENDOR_NAME , ' | ') WITHIN GROUP (ORDER BY POH_VENDOR_NAME) AS POH_VENDOR_NAME,
                POL_SOURCE,
                --POL_DOCUMENT_TYPE,
                PO_LINE_ITEM_NUMBER,
                SUM(POL_QUANTITY) AS POL_QUANTITY ,
                MAX(PO_LINE_UNIT_OF_MEASURE) AS PO_LINE_UNIT_OF_MEASURE,
                SUM(POL_AMOUNT) AS POL_AMOUNT,
                --PT.DESCRIPTION
                --PO_LINE_LINENO,
                LISTAGG ( DISTINCT PT.DESCRIPTION, ' | ' ) WITHIN GROUP (ORDER BY PT.DESCRIPTION)
                 --WITHIN GROUP ( ORDER BY POH_BC_PURCHASEHEADER_NUMBER)
                AS PO_PT_DESCRIPTION--WITHIN GROUP POH_BC_PURCHASEHEADER_NUMBER 
            FROM PO_H_BC
                LEFT JOIN PO_L_BC ON PO_H_BC.POH_BC_PURCHASEHEADER_NUMBER = PO_L_BC.POL_BC_PURCHASEHEADER_NUMBER
                AND UPPER(POH_SOURCE) = UPPER(POL_SOURCE)
                AND PO_L_BC.POL_CURRENT_FLAG = 1 --8603 --6530
                LEFT JOIN DWH.DIM_PAYMENTTERMS_BC PT ON PO_H_BC.POH_PAYMENT_TERMS_CODE = PT.CODE
                AND UPPER(POH_SOURCE) = UPPER(PT.SOURCE)
                AND PT.CURRENT_FLAG = 1
                AND UPPER(PT.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --6530
            WHERE PO_H_BC.POH_CURRENT_FLAG = 1
                AND UPPER(POH_SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                AND POL_DOCUMENT_TYPE = 'Order'
                AND PO_LINE_ITEM_NUMBER NOT IN (
                    '999998',
                    '999999',
                    'C600000-10',
                    'C600000-5',
                    'C600000-51',
                    'L15001',
                    'A46010',
                    'C600000-11',
                    'R700020')
            GROUP BY 
                POH_BC_PURCHASEHEADER_NUMBER,
                POH_SOURCE,
                POL_SOURCE,
                POH_FINAL_COSTING_SHEET_CODE,
                PO_LINE_ITEM_NUMBER
                
        ) --SELECT * FROM PO; -- 6534 rows
        /*SELECT POH_BC_PURCHASEHEADER_NUMBER, PO_LINE_ITEM_NUMBER, POH_FINAL_COSTING_SHEET_CODE, COUNT(*) FROM PO
        GROUP BY POH_BC_PURCHASEHEADER_NUMBER, PO_LINE_ITEM_NUMBER, POH_FINAL_COSTING_SHEET_CODE
        HAVING COUNT(*)>1 ; */       
,
        CS_PO AS (
            (
                SELECT *
                FROM CS
                    LEFT JOIN PO ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        POH_FINAL_COSTING_SHEET_CODE
                    )
                    AND CSH_SOURCE = POH_SOURCE
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_ITEM_NUMBER, PO_LINE_ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_PO_NUMBER, POH_BC_PURCHASEHEADER_NUMBER)
               /* WHERE CS_ITEM_PO IN (
                        SELECT DISTINCT CS_ITEM_PO
                        FROM SPR_CS_SING_ITEM_PO*/
                    )
            )
           /* UNION
            (
                SELECT *
                FROM SPR_CS_VT
                    LEFT JOIN PO ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        POH_FINAL_COSTING_SHEET_CODE
                    )
                    AND SPRH_SOURCE = POH_SOURCE
                    AND EQUAL_NULL(SPRL_ITEM_NUMBER, PO_LINE_ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_PO_NUMBER, POH_BC_PURCHASEHEADER_NUMBER)
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_LINENUMBER, PO_LINE_LINENO)
                WHERE CS_ITEM_PO IN (
                        SELECT DISTINCT CS_ITEM_PO
                        FROM SPR_CS_MULTI_ITEM
                    )
            )
        ) */--SELECT * FROM CS_PO; --6321 rows -6337 rows
        /*SELECT SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER, CSH_BC_COSTINGSHEET_NUMBER,CSL_BC_COSTINGSHEET_ITEM_NUMBER, CSL_PO_NUMBER,--SPRL_LINE_NUMBER, 
         COUNT(*) FROM SPRCSVT_PO GROUP BY SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER, CSH_BC_COSTINGSHEET_NUMBER, CSL_BC_COSTINGSHEET_ITEM_NUMBER, CSL_PO_NUMBER --, SPRL_LINE_NUMBER 
         HAVING COUNT(*)>1;*/
        --
,
        POSTED_INVOICE_H AS(
            SELECT 
                PI_ORDERNO,
                PPH.SOURCE AS POSTED_INVOICE_H_SOURCE,
                PI_VENDOR_INVOICE_NO,
                PI_CANCELLED,
                PI_SOURCECODE,
                PI_PAYMENT_TERMS_CODE,
                PI_PURCHASE_FROM_VENDOR_NUMBER,
                BC_PI_NUMBER AS POSTED_INVOICE_H_BC_PI_NUMBER,
                PI_COSTING_SHEET_CODE,
                NAME AS PPH_VENDOR_NAME
            FROM DWH.FCT_POSTED_PURCHASE_INVOICE_HEADER_BC PPH
            LEFT JOIN DWH.DIM_Vendors_BC VENDBC ON PPH.PI_PURCHASE_FROM_VENDOR_NUMBER = VENDBC.NO
            AND UPPER(PPH.SOURCE) = UPPER(VENDBC.SOURCE)
            AND VENDBC.CURRENT_FLAG = 1
            WHERE PPH.CURRENT_FLAG = 1
                AND UPPER(PPH.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --4647
        ),
        POSTED_INVOICE_L AS (
            SELECT 
                BC_PI_NUMBER AS POSTED_INVOICE_L_BC_PI_NUMBER,
                SOURCE AS POSTED_INVOICE_L_SOURCE,
                PI_BUY_FROM_VENDOR_NUMBER,
                PI_LINE_NO AS PI_ITEM_NO,
                PI_LINE_NUMBER,
                PI_LINE_UNIT_OF_MEASURE,
                PI_QUANTITY,
                PI_LINE_AMOUNT_LCY
            FROM DWH.FCT_POSTED_PURCHASE_INVOICE_LINE_BC
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --8049
        ),
        POSTED_INVOICE_ITEM AS (
            SELECT 
                    PI_ORDERNO,
                    POSTED_INVOICE_H_SOURCE,
                    LISTAGG(DISTINCT PI_VENDOR_INVOICE_NO, ' | ' ) WITHIN GROUP (ORDER BY PI_VENDOR_INVOICE_NO) AS PI_VENDOR_INVOICE_NO,
                    --PI_CANCELLED,
                    --PI_SOURCECODE,
                    --PI_PAYMENT_TERMS_CODE,
                    LISTAGG(DISTINCT PI_PURCHASE_FROM_VENDOR_NUMBER, ' | ' ) WITHIN GROUP (ORDER BY PI_PURCHASE_FROM_VENDOR_NUMBER) AS      PI_PURCHASE_FROM_VENDOR_NUMBER,
                    LISTAGG(DISTINCT PPH_VENDOR_NAME , ' | ') WITHIN GROUP (ORDER BY PPH_VENDOR_NAME)  AS PPH_VENDOR_NAME, 
                    POSTED_INVOICE_H_BC_PI_NUMBER,
                    PI_COSTING_SHEET_CODE,
                    --POSTED_INVOICE_L_BC_PI_NUMBER,
                    --POSTED_INVOICE_L_SOURCE,
                    LISTAGG(DISTINCT PI_BUY_FROM_VENDOR_NUMBER, ' | ' ) WITHIN GROUP (ORDER BY PI_BUY_FROM_VENDOR_NUMBER) AS PI_BUY_FROM_VENDOR_NUMBER,
                    PI_ITEM_NO,
                    --PI_LINE_NUMBER,
                    MAX(PI_LINE_UNIT_OF_MEASURE) AS PI_LINE_UNIT_OF_MEASURE,
                    SUM(PI_QUANTITY) AS PI_QUANTITY,
                    SUM(PI_LINE_AMOUNT_LCY) AS PI_LINE_AMOUNT_LCY,
                    LISTAGG(DISTINCT PT.DESCRIPTION, ' | ' ) WITHIN GROUP (ORDER BY PT.DESCRIPTION) AS PI_PT_DESCRIPTION                
            FROM POSTED_INVOICE_H
                LEFT JOIN POSTED_INVOICE_L ON POSTED_INVOICE_H_BC_PI_NUMBER = POSTED_INVOICE_L_BC_PI_NUMBER
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(POSTED_INVOICE_L_SOURCE)
                LEFT JOIN DWH.DIM_PAYMENTTERMS_BC PT ON PI_PAYMENT_TERMS_CODE = PT.CODE
                AND PT.CURRENT_FLAG = 1
                AND UPPER(PT.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(PT.SOURCE)
            WHERE PI_CANCELLED <> true
                AND PI_SOURCECODE <> 'DELETE'
                AND PI_ITEM_NO NOT IN (
                    '999998',
                    '999999',
                    'C600000-10',
                    'C600000-5',
                    'C600000-51',
                    'L15001',
                    'A46010',
                    'C600000-11',
                    'R700020'
                    ) --6067
                GROUP BY 
                    PI_ORDERNO,
                    POSTED_INVOICE_H_SOURCE,
                    POSTED_INVOICE_H_BC_PI_NUMBER,
                    PI_COSTING_SHEET_CODE,
                    PI_ITEM_NO
        ) --SELECT * FROM POSTED_INVOICE; -- 6067 rows -- 6105 rows
       /* SELECT POSTED_INVOICE_H_BC_PI_NUMBER, COUNT(DISTINCT PI_ORDERNO) FROM POSTED_INVOICE GROUP BY POSTED_INVOICE_H_BC_PI_NUMBER
        HAVING COUNT(DISTINCT PI_ORDERNO)>1 ;*/
        /*SELECT POSTED_INVOICE_H_BC_PI_NUMBER,PI_ORDERNO,PI_COSTING_SHEET_CODE , PI_ITEM_NO, COUNT(*)  FROM POSTED_INVOICE
        GROUP BY POSTED_INVOICE_H_BC_PI_NUMBER,PI_ORDERNO,PI_COSTING_SHEET_CODE , PI_ITEM_NO
        HAVING COUNT(*)>1;*/
,POSTED_INVOICE_FRT AS (
            SELECT 
                --POSTED_INVOICE_H.PI_ORDERNO AS PPI_H_FRT_PI_ORDERNO,
                POSTED_INVOICE_H.POSTED_INVOICE_H_SOURCE AS PPI_H_FRT_SOURCE,
                LISTAGG(POSTED_INVOICE_H.PI_PURCHASE_FROM_VENDOR_NUMBER, ' | ')
                WITHIN GROUP (ORDER BY POSTED_INVOICE_H.PI_PURCHASE_FROM_VENDOR_NUMBER)
                AS PPI_H_FRT_PI_PURCHASE_FROM_VENDOR_NUMBER,
                LISTAGG(POSTED_INVOICE_H.POSTED_INVOICE_H_BC_PI_NUMBER, ' | ')
                WITHIN GROUP (ORDER BY POSTED_INVOICE_H.POSTED_INVOICE_H_BC_PI_NUMBER)
                AS PPI_H_FRT_BC_PI_NUMBER,
                POSTED_INVOICE_H.PI_COSTING_SHEET_CODE AS PPI_H_FRT_PI_COSTING_SHEET_CODE,
                --POSTED_INVOICE_L.PI_ITEM_NO AS PPI_L_FRT_PI_ITEM_NO,
                --POSTED_INVOICE_L.PI_LINE_NUMBER AS PPI_L_FRT_PI_LINE_NUMBER,
                --POSTED_INVOICE_L.PI_LINE_UNIT_OF_MEASURE AS PPI_L_FRT_PI_LINE_UNIT_OF_MEASURE,
                SUM(POSTED_INVOICE_L.PI_QUANTITY) AS PPI_L_FRT_PI_QUANTITY,
                SUM(POSTED_INVOICE_L.PI_LINE_AMOUNT_LCY) AS PPI_L_FRT_PI_LINE_AMOUNT_LCY,
                --PT.DESCRIPTION AS PI_PT_DESCRIPTION
            FROM POSTED_INVOICE_H
                LEFT JOIN POSTED_INVOICE_L ON POSTED_INVOICE_H_BC_PI_NUMBER = POSTED_INVOICE_L_BC_PI_NUMBER
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(POSTED_INVOICE_L_SOURCE)
                LEFT JOIN DWH.DIM_PAYMENTTERMS_BC PT ON PI_PAYMENT_TERMS_CODE = PT.CODE
                AND PT.CURRENT_FLAG = 1
                AND UPPER(PT.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(PT.SOURCE)
            WHERE PI_CANCELLED <> true
                AND PI_SOURCECODE <> 'DELETE'
                AND PI_ITEM_NO  IN (
                    '999999',
                    'C600000-5',
                    'C600000-51',
                    'L15001'
                    )
            GROUP BY POSTED_INVOICE_H_SOURCE, PI_COSTING_SHEET_CODE
                    
                    --6067
        ) --SELECT * FROM POSTED_INVOICE_FRT; -- 6067 rows
        /*SELECT PPI_H_FRT_PI_COSTING_SHEET_CODE, COUNT(*) FROM POSTED_INVOICE_FRT
            GROUP BY PPI_H_FRT_PI_COSTING_SHEET_CODE
            HAVING COUNT(*)>1
        ;*/
    ,POSTED_INVOICE_INS AS (
            SELECT 
                --POSTED_INVOICE_H.PI_ORDERNO AS PPI_H_INS_PI_ORDERNO,
                POSTED_INVOICE_H.POSTED_INVOICE_H_SOURCE AS PPI_H_INS_SOURCE,
                LISTAGG(POSTED_INVOICE_H.PI_PURCHASE_FROM_VENDOR_NUMBER, ' | ')
                WITHIN GROUP (ORDER BY POSTED_INVOICE_H.PI_PURCHASE_FROM_VENDOR_NUMBER)
                AS PPI_H_INS_PI_PURCHASE_FROM_VENDOR_NUMBER,
                LISTAGG(POSTED_INVOICE_H.POSTED_INVOICE_H_BC_PI_NUMBER, ' | ')
                WITHIN GROUP (ORDER BY POSTED_INVOICE_H.POSTED_INVOICE_H_BC_PI_NUMBER)
                AS PPI_H_INS_BC_PI_NUMBER,
                POSTED_INVOICE_H.PI_COSTING_SHEET_CODE AS PPI_H_INS_PI_COSTING_SHEET_CODE,
                --POSTED_INVOICE_L.PI_ITEM_NO AS PPI_L_INS_PI_ITEM_NO,
                --POSTED_INVOICE_L.PI_LINE_NUMBER AS PPI_L_INS_PI_LINE_NUMBER,
                --POSTED_INVOICE_L.PI_LINE_UNIT_OF_MEASURE AS PPI_L_INS_PI_LINE_UNIT_OF_MEASURE,
                SUM(POSTED_INVOICE_L.PI_QUANTITY) AS PPI_L_INS_PI_QUANTITY,
                SUM(POSTED_INVOICE_L.PI_LINE_AMOUNT_LCY) AS PPI_L_INS_PI_LINE_AMOUNT_LCY,
                --PT.DESCRIPTION AS PI_PT_DESCRIPTION
            FROM POSTED_INVOICE_H
                LEFT JOIN POSTED_INVOICE_L ON POSTED_INVOICE_H_BC_PI_NUMBER = POSTED_INVOICE_L_BC_PI_NUMBER
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(POSTED_INVOICE_L_SOURCE)
                LEFT JOIN DWH.DIM_PAYMENTTERMS_BC PT ON PI_PAYMENT_TERMS_CODE = PT.CODE
                AND PT.CURRENT_FLAG = 1
                AND UPPER(PT.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
                AND UPPER(POSTED_INVOICE_H_SOURCE) = UPPER(PT.SOURCE)
            WHERE PI_CANCELLED <> true
                AND PI_SOURCECODE <> 'DELETE'
                AND PI_ITEM_NO  IN ('999998')
            GROUP BY POSTED_INVOICE_H_SOURCE, PI_COSTING_SHEET_CODE
                    
                    --6067
        ) -- SELECT * FROM POSTED_INVOICE_INS; -- 6067 rows
        /*SELECT PPI_H_FRT_PI_COSTING_SHEET_CODE, COUNT(*) FROM POSTED_INVOICE_FRT
            GROUP BY PPI_H_FRT_PI_COSTING_SHEET_CODE
            HAVING COUNT(*)>1;*/
, POSTED_INVOICE AS 
(
 SELECT * FROM POSTED_INVOICE_ITEM
    LEFT JOIN POSTED_INVOICE_FRT ON EQUAL_NULL(PI_COSTING_SHEET_CODE, PPI_H_FRT_PI_COSTING_SHEET_CODE) 
        AND POSTED_INVOICE_H_SOURCE = PPI_H_FRT_SOURCE
    LEFT JOIN POSTED_INVOICE_INS ON EQUAL_NULL(PI_COSTING_SHEET_CODE, PPI_H_INS_PI_COSTING_SHEET_CODE) 
        AND POSTED_INVOICE_H_SOURCE = PPI_H_INS_SOURCE
)
--SELECT * FROM POSTED_INVOICE;        
,
        CSFINAL_PPI AS (
            (
                SELECT *
                FROM CS_PO
                    LEFT JOIN POSTED_INVOICE ON EQUAL_NULL(CSH_BC_COSTINGSHEET_NUMBER, PI_COSTING_SHEET_CODE)
                    AND CSH_SOURCE = POSTED_INVOICE_H_SOURCE
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_ITEM_NUMBER, PI_ITEM_NO)
                    AND EQUAL_NULL(CSL_PO_NUMBER, PI_ORDERNO)
                /*WHERE CS_ITEM_PO IN (
                        SELECT DISTINCT CS_ITEM_PO
                        FROM SPR_CS_SING_ITEM_PO
                    )*/
            )
            /*UNION
            (
                SELECT *
                FROM SPRCSVT_PO
                    LEFT JOIN POSTED_INVOICE ON EQUAL_NULL(CSH_BC_COSTINGSHEET_NUMBER, PI_COSTING_SHEET_CODE)
                    AND SPRH_SOURCE = POSTED_INVOICE_H_SOURCE
                    AND EQUAL_NULL(SPRL_ITEM_NUMBER, PI_ITEM_NO)
                    AND EQUAL_NULL(CSL_PO_NUMBER, PI_ORDERNO)
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_LINENUMBER, PI_LINE_NUMBER)
                WHERE CS_ITEM_PO IN (
                        SELECT DISTINCT CS_ITEM_PO
                        FROM SPR_CS_MULTI_ITEM
                    )
            )*/
        )
       --SELECT * FROM CSFINAL_PPI; ---5552 rows -- 6321 rows -- 6337 rows
        /*SELECT SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER, CSH_BC_COSTINGSHEET_NUMBER,CSL_BC_COSTINGSHEET_ITEM_NUMBER, CSL_PO_NUMBER,--SPRL_LINE_NUMBER, 
         COUNT(*) FROM CSFINAL_PPI GROUP BY SPRH_BC_REQUESTNO, SPRL_ITEM_NUMBER, CSH_BC_COSTINGSHEET_NUMBER, CSL_BC_COSTINGSHEET_ITEM_NUMBER, CSL_PO_NUMBER --, SPRL_LINE_NUMBER 
         HAVING COUNT(*)>1;*/
,
        SO_H_BC AS(
            SELECT SOURCE AS SOH_SOURCE,
                SALES_ORDER_NUMBER AS SOH_SALES_ORDER_NUMBER,
                COALESCE(
                    NULLIF(SO_COSTING_SHEET_CODE, ''),
                    BC_COSTINGSHEET_NUMBER
                ) AS SOH_FINAL_COSTING_SHEET_CODE,
                SO_SELL_TO_CUSTOMER_NUMBER
            FROM DWH.FCT_SALES_ORDER_HEADER_BC
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --3391
        ),
        SO_L_BC AS(
            SELECT SALES_ORDER_NUMBER AS SOL_SALES_ORDER_NUMBER,
                SOURCE AS SOL_SOURCE,
                CURRENT_FLAG,
                SO_LINE_LINEAMOUNT,
                SO_LINE_LINE_NO,
                SO_LINE_ITEM_NUMBER,
                SO_LINE_DOCUEMENT_TYPE,
                SO_LINE_QUANITITY,
                SO_LINE_PURCHASE_ORDER_NO,
                SO_LINE_PURCHASE_ORDER_LINE_NO,
                SO_LINE_PURCHASING_CODE
            FROM DWH.FCT_SALES_ORDER_LINE_BC
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1) --13291
        ),
        SO AS (
            SELECT *
            FROM SO_H_BC
                LEFT JOIN SO_L_BC ON SOH_SALES_ORDER_NUMBER = SOL_SALES_ORDER_NUMBER
                AND UPPER(SOH_SOURCE) = UPPER(SOL_SOURCE)
            WHERE SO_LINE_DOCUEMENT_TYPE = 'Order'
                AND SO_LINE_ITEM_NUMBER NOT IN (
                    '999998',
                    '999999',
                    'C600000-10',
                    'C600000-5',
                    'C600000-51',
                    'L15001',
                    'A46010',
                    'C600000-11',
                    'R700020'
                )
        ) 
        --SELECT * FROM SO; --6575 rows
        /*SELECT SOH_SALES_ORDER_NUMBER, SOH_FINAL_COSTING_SHEET_CODE, SO_LINE_ITEM_NUMBER, COUNT(*) FROM SO
        GROUP BY SOH_SALES_ORDER_NUMBER, SOH_FINAL_COSTING_SHEET_CODE, SO_LINE_ITEM_NUMBER
        HAVING  COUNT(*)>1;*/
        --SELECT * FROM SO WHERE SOH_FINAL_COSTING_SHEET_CODE IN (SELECT CSH_BC_COSTINGSHEET_NUMBER FROm SPR_CS_MULTI_SO);
,
        SPRCSVT_SO AS (
            (
                SELECT *
                FROM CS
                    LEFT JOIN SO ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        SOH_FINAL_COSTING_SHEET_CODE
                    )
                    AND CSH_SOURCE = SOH_SOURCE
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_ITEM_NUMBER, SO_LINE_ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_SO_NUMBER, SOH_SALES_ORDER_NUMBER)
                WHERE CS_ITEM_SO IN (
                        SELECT DISTINCT CS_ITEM_SO
                        FROM SPR_CS_SING_NONORA_ITEM_SO
                    )
            )
           /* UNION
            (
                SELECT *
                FROM SPR_CS_VT
                    LEFT JOIN PO ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        POH_FINAL_COSTING_SHEET_CODE
                    )
                    AND SPRH_SOURCE = POH_SOURCE
                    AND EQUAL_NULL(SPRL_ITEM_NUMBER, PO_LINE_ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_PO_NUMBER, BC_PURCHASEHEADER_NUMBER)
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_LINENUMBER, PO_LINE_LINENO)
                WHERE CS_ITEM_PO IN (
                        SELECT DISTINCT CS_ITEM_PO
                        FROM SPR_CS_MULTI_ITEM
                    )
            )*/
        )
       -- SELECT * FROM SPRCSVT_SO;
/*
    SELECT SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --SPRL_LINE_NUMBER, 
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            SPRL_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) AS CS_ITEM_PO,
        --CSL_SO_NUMBER,
        COUNT(*)
    FROM SPRCSVT_SO 
    GROUP BY SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            SPRL_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1;*/
,
        POSTED_SALES_H AS (
            SELECT 
                BC_ORDER_NUMBER,
                SOURCE AS POSTED_SALES_H_SOURCE,
                BC_SI_NUMBER AS POSTED_SALES_H_BC_SI_NO,
                SI_COSTING_SHEET_CODE,
                SI_DOCUMENT_DATE,
                SI_POSTING_DATE,
                SI_SYSTEM_CREATED_AT,
                CANCELLED_FLAG
                FROM DWH.FCT_POSTED_SALES_INVOICE_HEADER_BC SLINV_H
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
        ),
        POSTED_SALES_L AS (
            SELECT 
                BC_SI_DOC_NUMBER,
                SOURCE AS POSTED_SALES_L_SOURCE,
                BC_SI_NUMBER AS ITEM_NUMBER,
                BC_SI_LINE_AMOUNT,
                BC_SI_LINE_QUANTITY,
                BC_SI_LINE_UNIT_OF_MEASURE,
                BC_SI_LINE_NUMBER
            FROM DWH.FCT_POSTED_SALES_INVOICE_LINE_BC
            WHERE CURRENT_FLAG = 1
                AND UPPER(SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
        ),
        POSTED_SALES_ITEM AS (
            SELECT 
                BC_ORDER_NUMBER,
                POSTED_SALES_H_SOURCE,
                POSTED_SALES_H_BC_SI_NO,
                SI_COSTING_SHEET_CODE,
                --SI_DOCUMENT_DATE,
                MIN(SI_POSTING_DATE) AS MIN_SI_POSTING_DATE,
                MAX(SI_POSTING_DATE) AS SI_POSTING_DATE,
                LISTAGG( DISTINCT SI_POSTING_DATE, ' | ' ) WITHIN GROUP (ORDER BY SI_POSTING_DATE) AS LIST_SI_POSTING_DATE,
                --SI_SYSTEM_CREATED_AT,
                --BC_SI_DOC_NUMBER,
                --POSTED_SALES_L_SOURCE,
                ITEM_NUMBER,
                SUM(BC_SI_LINE_AMOUNT) AS BC_SI_LINE_AMOUNT,
                SUM(BC_SI_LINE_QUANTITY) AS BC_SI_LINE_QUANTITY,
                MAX(BC_SI_LINE_UNIT_OF_MEASURE) AS BC_SI_LINE_UNIT_OF_MEASURE
                --BC_SI_LINE_NUMBER
            FROM POSTED_SALES_H
                LEFT JOIN POSTED_SALES_L ON POSTED_SALES_H_BC_SI_NO = BC_SI_DOC_NUMBER
                AND UPPER(POSTED_SALES_H_SOURCE) = UPPER(POSTED_SALES_L_SOURCE) -- WHERE POSTED_SALES_H.CURRENT_FLAG = 1
                --     AND UPPER(SLINV_H.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
            WHERE ITEM_NUMBER NOT IN (
                    '999998',
                    '999999',
                    'C600000-10',
                    'C600000-5',
                    'C600000-51',
                    'L15001',
                    'A46010',
                    'C600000-11',
                    'R700020'
                ) AND CANCELLED_FLAG <> 'TRUE'
            GROUP BY 
                BC_ORDER_NUMBER,
                POSTED_SALES_H_SOURCE,
                POSTED_SALES_H_BC_SI_NO,
                SI_COSTING_SHEET_CODE,
                ITEM_NUMBER
        ) --SELECT * FROM POSTED_SALES_ITEM; --7318 -- 5682 rows
        /*SELECT BC_ORDER_NUMBER,POSTED_SALES_H_BC_SI_NO, SI_COSTING_SHEET_CODE, ITEM_NUMBER, COUNT(*) FROM POSTED_SALES_ITEM
        GROUP BY BC_ORDER_NUMBER,POSTED_SALES_H_BC_SI_NO, SI_COSTING_SHEET_CODE, ITEM_NUMBER
        HAVING COUNT(*)>1;*/
        --SELECT * FROM POSTED_SALES_ITEM WHERE SI_COSTING_SHEET_CODE IN (SELECT CSH_BC_COSTINGSHEET_NUMBER FROm SPR_CS_MULTI_SO);
        --SELECT * FROM POSTED_INVOICE;
   -- SELECT DISTINCT CS_ITEM_SO  FROM SPR_CS_MULTI_SO WHERE CS_ITEM_SO LIKE '%PI-WE/2024/0379%';
   , POSTED_SALES_FRT AS (
        SELECT  --BC_ORDER_NUMBER,
                POSTED_SALES_H_SOURCE AS PSH_FRT_SOURCE,
                LISTAGG(DISTINCT POSTED_SALES_H_BC_SI_NO, ' | ')
                WITHIN GROUP (ORDER BY POSTED_SALES_H_BC_SI_NO)
                AS PSH_FRT_BC_SI_NO,
                SI_COSTING_SHEET_CODE AS PSH_FRT_SI_COSTING_SHEET_CODE,
                LISTAGG(DISTINCT BC_SI_DOC_NUMBER , ' | ')
                WITHIN GROUP (ORDER BY BC_SI_DOC_NUMBER)                
                AS PSL_FRT_BC_SI_DOC_NUMBER,
                --POSTED_SALES_L_SOURCE AS PSL_FRT_SOURCE,
                --ITEM_NUMBER AS PSL_FRT_ITEM_NUMBER,
                SUM(BC_SI_LINE_AMOUNT) AS PSL_FRT_LINE_AMOUNT,
                SUM(BC_SI_LINE_QUANTITY) AS PSL_FRT_LINE_QUANTITY                
            FROM POSTED_SALES_H
                LEFT JOIN POSTED_SALES_L ON POSTED_SALES_H_BC_SI_NO = BC_SI_DOC_NUMBER
                AND UPPER(POSTED_SALES_H_SOURCE) = UPPER(POSTED_SALES_L_SOURCE) -- WHERE POSTED_SALES_H.CURRENT_FLAG = 1
                --     AND UPPER(SLINV_H.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
            WHERE ITEM_NUMBER IN (
            '999999',
            'C600000-5',
            'C600000-51',
            'L15001'
        )
                AND CANCELLED_FLAG <> 'TRUE'
        GROUP BY SI_COSTING_SHEET_CODE, POSTED_SALES_H_SOURCE
        
)
--SELECT * FROM POSTED_SALES_FRT;
/*SELECT PSH_FRT_SI_COSTING_SHEET_CODE , COUNT(*) FROM POSTED_SALES_FRT
GROUP BY PSH_FRT_SI_COSTING_SHEET_CODE
HAVING COUNT(*)>1;*/
, POSTED_SALES_INS AS (
        SELECT  --BC_ORDER_NUMBER,
                POSTED_SALES_H_SOURCE AS PSH_INS_SOURCE,
                LISTAGG(DISTINCT POSTED_SALES_H_BC_SI_NO, ' | ')
                WITHIN GROUP (ORDER BY POSTED_SALES_H_BC_SI_NO)
                AS PSH_INS_BC_SI_NO,
                SI_COSTING_SHEET_CODE AS PSH_INS_SI_COSTING_SHEET_CODE,
                LISTAGG(DISTINCT BC_SI_DOC_NUMBER , ' | ')
                WITHIN GROUP (ORDER BY BC_SI_DOC_NUMBER)                
                AS PSL_INS_BC_SI_DOC_NUMBER,
                --POSTED_SALES_L_SOURCE AS PSL_FRT_SOURCE,
                --ITEM_NUMBER AS PSL_FRT_ITEM_NUMBER,
                SUM(BC_SI_LINE_AMOUNT) AS PSL_INS_LINE_AMOUNT,
                SUM(BC_SI_LINE_QUANTITY) AS PSL_INS_LINE_QUANTITY                
            FROM POSTED_SALES_H
                LEFT JOIN POSTED_SALES_L ON POSTED_SALES_H_BC_SI_NO = BC_SI_DOC_NUMBER
                AND UPPER(POSTED_SALES_H_SOURCE) = UPPER(POSTED_SALES_L_SOURCE) -- WHERE POSTED_SALES_H.CURRENT_FLAG = 1
                --     AND UPPER(SLINV_H.SOURCE) IN (SELECT SOURCE FROM VIEW_REPORT_FILTERS WHERE TCC_FLAG =1)
            WHERE ITEM_NUMBER IN ('999998')
                AND CANCELLED_FLAG <> 'TRUE'
        GROUP BY SI_COSTING_SHEET_CODE, POSTED_SALES_H_SOURCE
        
)
--SELECT * FROM POSTED_SALES_INS;
/*SELECT PSH_INS_SI_COSTING_SHEET_CODE , COUNT(*) FROM POSTED_SALES_INS
GROUP BY PSH_INS_SI_COSTING_SHEET_CODE
HAVING COUNT(*)>1;*/
   , POSTED_SALES AS 
(
 SELECT * FROM POSTED_SALES_ITEM
    LEFT JOIN POSTED_SALES_FRT ON EQUAL_NULL(SI_COSTING_SHEET_CODE, PSH_FRT_SI_COSTING_SHEET_CODE) 
        AND POSTED_SALES_H_SOURCE = PSH_FRT_SOURCE
    LEFT JOIN POSTED_SALES_INS ON EQUAL_NULL(SI_COSTING_SHEET_CODE, PSH_INS_SI_COSTING_SHEET_CODE) 
        AND POSTED_SALES_H_SOURCE = PSH_INS_SOURCE
)
--SELECT * FROM POSTED_SALES;

   
    , CSFINAL_PSI AS 
    (

                (
                SELECT *
                FROM CSFINAL_PPI
                    LEFT JOIN POSTED_SALES ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        SI_COSTING_SHEET_CODE
                    )
                    AND UPPER(CSH_SOURCE) = UPPER(POSTED_SALES_H_SOURCE)
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_ITEM_NUMBER, ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_SO_NUMBER, BC_ORDER_NUMBER)
               /* WHERE CS_ITEM_SO IN (
                        SELECT DISTINCT CS_ITEM_SO
                        FROM SPR_CS_SING_NONORA_ITEM_SO
                    )*/
            )
            /*UNION
            (
                SELECT *
                FROM SPR_CS_VT
                    LEFT JOIN POSTED_SALES ON EQUAL_NULL(
                        CSH_BC_COSTINGSHEET_NUMBER,
                        SI_COSTING_SHEET_CODE
                    )
                    AND SPRH_SOURCE = POSTED_SALES_H_SOURCE
                    AND EQUAL_NULL(SPRL_ITEM_NUMBER, ITEM_NUMBER)
                    AND EQUAL_NULL(CSL_SO_NUMBER, BC_ORDER_NUMBER)
                    AND EQUAL_NULL(CSL_BC_COSTINGSHEET_LINENUMBER, BC_SI_LINE_NUMBER)
                WHERE CS_ITEM_SO IN (
                        SELECT DISTINCT CS_ITEM_SO
                        FROM SPR_CS_MULTI_SO
                    )
            )*/
        
    )
   --SELECT * FROM CSFINAL_PSI; -- 4973 rows -- 5520 rows --5552 rows ---CS-WE01934, PI-WE/2025/0480 -- 6321 rows --6337 rows
    , AGG AS 
    ( SELECT 
            CSH_BC_COSTINGSHEET_NUMBER,
            CSH_SOURCE,
            SUM(CSL_BC_COSTINGSHEET_ITEM_QUANTITY) AS CS_QUANTITY,
            SUM(CSL_TOTAL_FOB_COST_USD) AS CSL_TOTAL_FOB_COST_USD,
            SUM(CSL_TOTAL_CI_CIF) AS CSL_TOTAL_CI_CIF,
            AVG(CSL_FX_RATE) AS CSL_FX_RATE,
            MAX(CSL_BC_COSTINGSHEET_SALES_UOM) AS CS_SALES_UOM,
            MAX(CSL_BC_COSTINGSHEET_PURCHASE_UOM) AS CS_PURCHASE_UOM,
            LISTAGG(DISTINCT CSL_SO_NUMBER,' | ') WITHIN GROUP (ORDER BY CSL_SO_NUMBER) AS CSL_SO_NUMBER,
            LISTAGG(DISTINCT CSL_PO_NUMBER,' | ')  WITHIN GROUP (ORDER BY CSL_PO_NUMBER) AS CSL_PO_NUMBER,
            LISTAGG(DISTINCT CS_ITEM_PO,' | ') WITHIN GROUP (ORDER BY CS_ITEM_PO) AS CS_ITEM_PO,
            LISTAGG(DISTINCT CS_ITEM_SO,' | ') WITHIN GROUP (ORDER BY CS_ITEM_SO) AS CS_ITEM_SO,
            LISTAGG(DISTINCT POH_BC_PURCHASEHEADER_NUMBER, ' | ') WITHIN GROUP (ORDER BY POH_BC_PURCHASEHEADER_NUMBER) AS POH_BC_PURCHASEHEADER_NUMBER ,
            LISTAGG(DISTINCT POH_VENDOR_INVOICE_NUMBER, ' | ') WITHIN GROUP (ORDER BY POH_VENDOR_INVOICE_NUMBER) AS POH_VENDOR_INVOICE_NUMBER,
            SUM(VENDOR_INVOICE_COUNT) AS VENDOR_INVOICE_COUNT,
            LISTAGG(DISTINCT POH_BUY_FROM_VENDOR_NUMBER, ' | ') WITHIN GROUP (ORDER BY POH_BUY_FROM_VENDOR_NUMBER) AS POH_BUY_FROM_VENDOR_NUMBER,
            LISTAGG(DISTINCT POH_VENDOR_NAME, ' | ') WITHIN GROUP (ORDER BY POH_VENDOR_NAME) AS POH_VENDOR_NAME, 
            LISTAGG(DISTINCT PO_LINE_ITEM_NUMBER, ' | ') WITHIN GROUP (ORDER BY PO_LINE_ITEM_NUMBER) AS PO_LINE_ITEM_NUMBER,
            SUM(POL_QUANTITY) AS POL_QUANTITY,
            MAX(PO_LINE_UNIT_OF_MEASURE) AS PO_LINE_UNIT_OF_MEASURE,
            SUM(POL_AMOUNT) AS POL_AMOUNT,
            LISTAGG(DISTINCT PO_PT_DESCRIPTION, ' | ') WITHIN GROUP (ORDER BY PO_PT_DESCRIPTION ) AS PO_PT_DESCRIPTION,
            LISTAGG(DISTINCT PI_ORDERNO, ' | ') WITHIN GROUP (ORDER BY PI_ORDERNO) AS PI_ORDERNO,
            LISTAGG(DISTINCT PI_VENDOR_INVOICE_NO, ' | ') WITHIN GROUP (ORDER BY PI_VENDOR_INVOICE_NO) AS PI_VENDOR_INVOICE_NO, 
            LISTAGG(DISTINCT PI_PURCHASE_FROM_VENDOR_NUMBER, ' | ') WITHIN GROUP (ORDER BY PI_PURCHASE_FROM_VENDOR_NUMBER) AS PI_PURCHASE_FROM_VENDOR_NUMBER,
            LISTAGG(DISTINCT PPH_VENDOR_NAME, ' | ') WITHIN GROUP (ORDER BY PPH_VENDOR_NAME) AS PPH_VENDOR_NAME, 
            LISTAGG(DISTINCT POSTED_INVOICE_H_BC_PI_NUMBER, ' | ') WITHIN GROUP (ORDER BY POSTED_INVOICE_H_BC_PI_NUMBER) AS POSTED_INVOICE_H_BC_PI_NUMBER,
            LISTAGG(DISTINCT PI_BUY_FROM_VENDOR_NUMBER, ' | ') WITHIN GROUP (ORDER BY PI_BUY_FROM_VENDOR_NUMBER) AS PI_BUY_FROM_VENDOR_NUMBER,
            LISTAGG(DISTINCT PI_ITEM_NO, ' | ') WITHIN GROUP (ORDER BY PI_ITEM_NO) AS PI_ITEM_NO,
            MAX(PI_LINE_UNIT_OF_MEASURE) AS PI_LINE_UNIT_OF_MEASURE,
            SUM(PI_QUANTITY) AS PI_QUANTITY,
            SUM(PI_LINE_AMOUNT_LCY) AS PI_LINE_AMOUNT_LCY,
            LISTAGG(DISTINCT PI_PT_DESCRIPTION, ' | ') WITHIN GROUP (ORDER BY PI_PT_DESCRIPTION) AS PI_PT_DESCRIPTION,
            LISTAGG(DISTINCT BC_ORDER_NUMBER, ' | ') WITHIN GROUP (ORDER BY BC_ORDER_NUMBER) AS BC_ORDER_NUMBER,
            LISTAGG(DISTINCT POSTED_SALES_H_BC_SI_NO, ' | ') WITHIN GROUP (ORDER BY POSTED_SALES_H_BC_SI_NO) AS POSTED_SALES_H_BC_SI_NO,
            --SI_COSTING_SHEET_CODE,
            MIN(MIN_SI_POSTING_DATE) AS MIN_SI_POSTING_DATE,
            MAX(SI_POSTING_DATE) AS SI_POSTING_DATE,
            LISTAGG(DISTINCT LIST_SI_POSTING_DATE, ' | ') WITHIN GROUP (ORDER BY LIST_SI_POSTING_DATE) AS LIST_SI_POSTING_DATE,
            LISTAGG(DISTINCT ITEM_NUMBER, ' | ') WITHIN GROUP (ORDER BY ITEM_NUMBER) AS SI_ITEM_NUMBER,
            SUM(BC_SI_LINE_AMOUNT) AS BC_SI_LINE_AMOUNT,
            SUM(BC_SI_LINE_QUANTITY) AS BC_SI_LINE_QUANTITY,
            MAX(BC_SI_LINE_UNIT_OF_MEASURE) AS BC_SI_LINE_UNIT_OF_MEASURE,
            SUM(PPI_L_FRT_PI_LINE_AMOUNT_LCY) AS PPI_L_FRT_PI_LINE_AMOUNT_LCY,
            SUM(PPI_L_INS_PI_LINE_AMOUNT_LCY) AS PPI_L_INS_PI_LINE_AMOUNT_LCY,
            SUM(PSL_FRT_LINE_AMOUNT) AS PSL_FRT_LINE_AMOUNT,
            SUM(PSL_INS_LINE_AMOUNT) AS PSL_INS_LINE_AMOUNT

            FROM CSFINAL_PSI
            GROUP BY 
            CSH_BC_COSTINGSHEET_NUMBER,
            CSH_SOURCE
      
        )
        --SELECT * FROM AGG; -- 3348 rows --3356 rows

    

    /*SELECT SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --SPRL_LINE_NUMBER, 
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            SPRL_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) AS CS_ITEM_PO,
        --CSL_SO_NUMBER,
        COUNT(*)
    FROM CSFINAL_PSI 
    GROUP BY SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_PO_NUMBER,
        --CSL_SO_NUMBER,
        CONCAT(
            IFNULL(CSH_BC_COSTINGSHEET_NUMBER, ''),
            SPRL_ITEM_NUMBER,
            IFNULL(CSL_PO_NUMBER, '')
        ) --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1;*/
    ,FINAL AS 
        (
        SELECT 
            A.SPRH_BC_REQUESTNO,
            A.SPRH_CUSTOMER_NUMBER,
            A.SPRH_CUSTOMER_NAME,
            A.SPRH_PR_DESCRIPTION AS SPR_Description,
            A.SPRH_SOURCE,
            A.SPRH_BC_CUSTOMER_PR_NUMBER,
            A.SPR_CREATION_DATE,
            A.SPRH_PR_CREATED_BY,
            A.SPRH_PR_MODIFIED_BY,
           --A.SPRL_ITEM_DESCRIPTION,
            A.CSH_BC_COSTINGSHEET_NUMBER,
            A.CSH_VENDOR_NAME,
            A.CSH_BC_CUSTOMER_PR_NUMBER,
            A.CSH_PORT_OF_LOADING,
            A.CSH_PORT_OF_DISCHARGE,
            A.CSH_SOURCE,
            A.CSH_BC_REQUESTNO,
            A.CSH_NUMBER_OF_CONTAINERS,
            A.CSH_VENDOR_CODE,
            A.CSH_CONTAINER_TYPE,
            A.CSH_COSTINGSHEET_DATE,
            A.CSH_BC_CUSTOMER_ID,
            A.CSH_CUSTOMER_NAME,
            A.CSH_PAYMENT_TERMS_CODE_VENDOR,
            A.CSH_BC_COSTINGSHEET_STATUS,
            A.CSH_CS_STAGE,
            A.CSH_PT_DESCRIPTION,
            A.VT_SOURCE,
            A.VT_SUPPLIER_INCOTERMS,
            A.VT_BC_CUSTOMER_PO_NUMBER,
            A.VT_NO_OF_CONTAINERS,
            A.VT_BC_COSTINGSHEET_NUMBER,
            A.VT_SUPPLIER_ETD,
            A.VT_CARGO_READY_DATE,
            A.VT_ACTUAL_ETD,
            A.VT_ACTUAL_ETA,
            A.VT_REQUESTED_ETA,
            A.VT_SHIPPING_LINE,
            A.VT_BOOKING_REFERENCE_NUMBER,
            A.VT_VESSEL_NAME,
            A.VT_DULICENSE_NUMBER,
            A.VT_DU_EXPIRY_DATE,
            A.VT_TRACKING_AWB_NUMBER,
            --A.VT_DAYS_BW_ETD_DOCSENT,
            A.VT_BL_DATE,
            A.VT_GRN_DATE,
            A.VT_DC_DELIVERY_DATE,
            A.VT_VGM_SUBDATE,
            A.VT_SI_SUB_DATE,
            A.SL_PTP_LOADINGPORTETD,
            A.SL_PTP_LOADINGPORTATD,
            A.SL_PTP_DISCHARGEPORTETA,
            A.SL_PTP_DISCHARGEPORTATA,
            A.VT_BL_NUMBER, 
            A.CSH_MODE_OF_SHIPMENT,
            CS_QUANTITY,
            CS_SALES_UOM,
            CS_PURCHASE_UOM,
            CSL_SO_NUMBER,
            CSL_PO_NUMBER,
            CS_ITEM_PO,
            CS_ITEM_SO,
            POH_BC_PURCHASEHEADER_NUMBER,
            POH_VENDOR_INVOICE_NUMBER,
            VENDOR_INVOICE_COUNT,
            POH_BUY_FROM_VENDOR_NUMBER,
            PO_LINE_ITEM_NUMBER,
            POL_QUANTITY,
            PO_LINE_UNIT_OF_MEASURE,
            POL_AMOUNT,
            PO_PT_DESCRIPTION,
            PI_ORDERNO,
            PI_VENDOR_INVOICE_NO,
            PI_PURCHASE_FROM_VENDOR_NUMBER,
            POSTED_INVOICE_H_BC_PI_NUMBER,
            PI_BUY_FROM_VENDOR_NUMBER,
            PI_ITEM_NO,
            PI_LINE_UNIT_OF_MEASURE,
            PI_QUANTITY,
            PI_LINE_AMOUNT_LCY,
            PI_PT_DESCRIPTION,
            BC_ORDER_NUMBER,
            POSTED_SALES_H_BC_SI_NO,
            MIN_SI_POSTING_DATE,
            SI_POSTING_DATE,
            LIST_SI_POSTING_DATE,
            SI_ITEM_NUMBER,
            BC_SI_LINE_AMOUNT,
            BC_SI_LINE_QUANTITY,
            BC_SI_LINE_UNIT_OF_MEASURE,
            CASE WHEN UPPER(A.CSH_SOURCE)= 'BUSINESS_CENTRAL' THEN 'DMCC' 
                WHEN UPPER(A.CSH_SOURCE)= 'DIAGRAIN' THEN 'DIAGRAIN'
                WHEN UPPER(A.CSH_SOURCE)= 'VIVIA' THEN 'VIVIA'
                WHEN UPPER(A.CSH_SOURCE)= 'COMINSERVE' THEN 'COMINSERVE'
                WHEN UPPER(A.CSH_SOURCE)= 'NEXTRA' THEN 'NEXTRA'
                WHEN UPPER(A.CSH_SOURCE)= 'TUCOR' THEN 'TUCOR'
                ELSE NULL END AS SOURCING_OFFICE,  -- TBD
            PPH_VENDOR_NAME,
            POH_VENDOR_NAME,
            PPI_L_FRT_PI_LINE_AMOUNT_LCY,
            PPI_L_INS_PI_LINE_AMOUNT_LCY,
            PSL_FRT_LINE_AMOUNT,
            PSL_INS_LINE_AMOUNT,
            A.CSH_CS_MARGIN,
            A.CSH_EQUIPMENT_TYPE,
            A.CSH_FREIGHT_CURRENCY,
            A.CSH_FREIGHT_COST,
            CSL_FX_RATE,
            A.REQUEST_FOR_INSPECTION_FLAG,
            CSL_TOTAL_FOB_COST_USD,
            A.CSH_PETRAMAR_CHARGES,
            A.CSH_FREIGHT_PROVIDER,
            A.CSH_SHIPMENT_COUNTRY_CODE,
            CSL_TOTAL_CI_CIF,
            A.VT_CUSTOMER_DOC_SENT_DATE,
            A.VT_CUSTOMER_LC_NUMBER,
            A.CSH_CUST_NAME,
            A.VT_BOOKING_DATE,
            A.BC_CS_SYSTEM_CREATED_BY,
            A.BC_CS_SYSTEM_MODIFIED_BY,
            A.VT_CUSTOMER_DOC_RCV_DATE,
            A.VT_DRAFTAPDATE,
            A.VT_DISCHARGED_AT_POD

        FROM SPR_CS_VT A FULL OUTER JOIN AGG B -- Need to be evaluated again 
        ON  
                EQUAL_NULL(A.CSH_BC_COSTINGSHEET_NUMBER, B.CSH_BC_COSTINGSHEET_NUMBER)
            AND EQUAL_NULL(A.CSH_SOURCE,B.CSH_SOURCE)
                
            --AND EQUAL_NULL(A.CSl_PO_NUMBER, B.CSL_PO_NUMBER)
            --AND EQUAL_NULL(A.CSL_SO_NUMBER ,B.CSL_SO_NUMBER)
            --WHERE A.CSH_CS_STAGE <> 'Cancelled'
    
        )
 --SELECT * FROM FINAL; -- 3348 rows --356 rows

   /* SELECT SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER, CSL_PO_NUMBER,

        COUNT(*)
    FROM FINAL --WHERE SPRL_ITEM_NUMBER <> '100501'
    GROUP BY SPRH_BC_REQUESTNO,
        SPRL_ITEM_NUMBER,
        CSH_BC_COSTINGSHEET_NUMBER,
        CSL_BC_COSTINGSHEET_ITEM_NUMBER,
        CSL_SO_NUMBER,CSL_PO_NUMBER
 --, SPRL_LINE_NUMBER 
    HAVING COUNT(*) > 1;*/
    , BASE_LC AS 
        (
            SELECT 
                LC_NO,
                LINK_PFS ,
                TRIM(F.VALUE::string) AS LC_CS_ID,
                LC_TYPE,
                DOCUMENTARY_CREDIT_NO AS LC_DOCUMENTARY_CREDIT_NO,
                DATE_OF_ISSUE AS LC_DATE_OF_ISSUE,
                PLACE_OF_EXPIRY AS LC_PLACE_OF_EXPIRY,
                DATE_OF_EXPIRY AS LC_DATE_OF_EXPIRY,
                ISSUED_BY_ISSUED_TO AS LC_ISSUED_BY_ISSUED_TO,
                NAME AS LC_CUST_VEND_NAME,
                CURRENCY AS LC_CURRENCY,
                AMOUNT AS LC_AMOUNT,
                PAYMENT_TERMS AS LC_PAYMENT_TERMS,
                PAYMENT_TERMS_DESCRIPTION AS LC_PAYMENT_TERMS_DESCRIPTION,
                PRODUCT_DESCRIPTION AS LC_PRODUCT_DESCRIPTION,
                LC_CONFIRMATION,
                LC_DOCUMENT_STATUS,
                LC_INITIAL_VALUE,
                SOURCE AS LC_SOURCE
            FROM DWH.FCT_LC_DETAILS_BC LC
            ,
                 LATERAL FLATTEN(
                     INPUT => SPLIT(
                         REGEXP_REPLACE(LC.LINK_PFS, '[,& ]+', ' '),  
                         ' '
                     )
                 ) F
            WHERE CURRENT_FLAG=1
            AND UPPER(LC.SOURCE) = 'BUSINESS_CENTRAL'
            AND TRIM(F.VALUE::string) <> ''
        
        )
    , FINAL_LC AS 
        (
            SELECT 
             CASE 
                    WHEN COUNT(*) OVER (PARTITION BY LC_NO) = 1
                        THEN LC_NO
                    ELSE LC_NO || ' | ' || LC_CS_ID
                END AS LC_UNIQUE_ID,
                * 
            FROM BASE_LC
        )
       -- SELECT * FROM FINAL_LC;
    , CUST AS (
            
    SELECT 
           *,
        BC_SI_LINE_AMOUNT AS SELLING_FOB,
        COALESCE(
            NULLIF(PPH_VENDOR_NAME,''),
            NULLIF(POH_VENDOR_NAME,''),
            NULLIF(CSH_VENDOR_NAME,'')
           ) AS FINAL_VENDOR_NAME, 
        COALESCE(
            NULLIF(SPRH_BC_CUSTOMER_PR_NUMBER, ''),
            NULLIF(CSH_BC_CUSTOMER_PR_NUMBER, '')
        ) AS MPR,
        COALESCE(
            NULLIF(PI_VENDOR_INVOICE_NO, ''),
            NULLIF(POH_VENDOR_INVOICE_NUMBER,'')
        ) AS "Vendor Invoice",
        -- "Purchase Order Value",
        COALESCE(
            NULLIF(PI_PT_DESCRIPTION, ''),
            NULLIF(PO_PT_DESCRIPTION,''),
            CSH_PT_DESCRIPTION) AS "Vendor Payment Term",
        COALESCE(VT_NO_OF_CONTAINERS,CSH_NUMBER_OF_CONTAINERS) AS "No. Of Containers",--- Recheck
            CASE
            WHEN VT_NO_OF_CONTAINERS <> 0 THEN VT_NO_OF_CONTAINERS
            WHEN VT_NO_OF_CONTAINERS = 0
            AND CSH_NUMBER_OF_CONTAINERS <> 0 THEN CSH_NUMBER_OF_CONTAINERS
            WHEN CSH_NUMBER_OF_CONTAINERS = 0
            AND VT_NO_OF_CONTAINERS = 0 THEN 1
            ELSE 1
        END AS CALC_NUMBER_OF_CONTAINERS,
        CASE
            WHEN PI_LINE_AMOUNT_LCY <> 0
            AND PI_LINE_AMOUNT_LCY IS NOT NULL THEN PI_LINE_AMOUNT_LCY
            WHEN (PI_LINE_AMOUNT_LCY = 0
            OR PI_LINE_AMOUNT_LCY IS NULL)
            AND CSL_TOTAL_FOB_COST_USD <> 0 THEN CSL_TOTAL_FOB_COST_USD
            ELSE NULL
        END AS PURCHASE_FOB_USD,
        SUM(PURCHASE_FOB_USD) OVER (PARTITION BY CSH_BC_COSTINGSHEET_NUMBER, CSH_VENDOR_CODE) AS PURCHASE_FOB_CS_VENDOR_USD,
        SUM(PURCHASE_FOB_USD) OVER (PARTITION BY CSH_BC_COSTINGSHEET_NUMBER) AS PURCHASE_FOB_CS_USD,
        CASE
            WHEN CSH_FREIGHT_CURRENCY = 'USD' THEN CSH_FREIGHT_COST
            ELSE (CSH_FREIGHT_COST * CSL_FX_RATE)
        END AS CALC_CSH_FREIGHT_COST,
      
        NULLIF(
            (CALC_NUMBER_OF_CONTAINERS * CALC_CSH_FREIGHT_COST),
            0
        ) AS CSH_TOTAL_FREIGHT_COST,
        NULLIF(PPI_L_FRT_PI_LINE_AMOUNT_LCY, 0) AS CALC_PPL_FRT_LINE_AMT_USD,
        COALESCE(CALC_PPL_FRT_LINE_AMT_USD, CSH_TOTAL_FREIGHT_COST) AS TOTAL_FREIGHT_COST,
          CASE
            WHEN CSH_FREIGHT_PROVIDER = 'Petramar'
            AND CSH_SHIPMENT_COUNTRY_CODE = 'AO' THEN COALESCE(
                (CALC_PPL_FRT_LINE_AMT_USD -(CSH_PETRAMAR_CHARGES)),
                CSH_TOTAL_FREIGHT_COST
            )
            ELSE TOTAL_FREIGHT_COST
        END AS M_CS_TOTAL_FREIGHT_COST_LS_PETRAMAR,
        COALESCE((NULLIF(ZEROIFNULL(BC_SI_LINE_AMOUNT) +ZEROIFNULL(PSL_FRT_LINE_AMOUNT) +ZEROIFNULL(PSL_INS_LINE_AMOUNT),0)),
                NULLIF(CSL_TOTAL_CI_CIF,0))        
        AS CI_AMOUNT,

        COALESCE(
            NULLIF(CSL_PO_NUMBER,''),
            NULLIF(POH_BC_PURCHASEHEADER_NUMBER,''),
            NULLIF(PI_ORDERNO,'')) 
            AS FINAL_PO_NUMBER,
        CASE 
            WHEN NULLIF(POSTED_SALES_H_BC_SI_NO,'') IS NOT NULL THEN 'Invoiced'
            WHEN NULLIF(POSTED_SALES_H_BC_SI_NO,'') IS NULL
            AND (VT_SI_SUB_DATE IS NOT NULL AND VT_SI_SUB_DATE NOT IN ('1900-01-01', '0001-01-01')) THEN 'Invoice Pending'
            --WHEN NULLIF(POSTED_SALES_H_BC_SI_NO,'') IS NULL AND (VT_SI_SUB_DATE IS NULL OR VT_SI_SUB_DATE IN ('1900-01-01', '0001-01-01')) THEN 'Not Invoiced'
            ELSE 'Not Invoiced' END AS Invoicing_Status, -- Revalidate
        CASE
            WHEN FINAL.VT_SUPPLIER_ETD NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_SUPPLIER_ETD
            ELSE NULL
        END AS FINAL_VT_SUPPLIER_ETD,
        CASE
            WHEN FINAL.VT_CARGO_READY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_CARGO_READY_DATE
            ELSE NULL
        END AS FINAL_VT_CARGO_READY_DATE,
        CASE
            WHEN FINAL.VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_ACTUAL_ETD
            ELSE NULL
        END AS FINAL_VT_ACTUAL_ETD,
        CASE
            WHEN FINAL.VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_ACTUAL_ETA
            ELSE NULL
        END AS FINAL_VT_ACTUAL_ETA,
        CASE WHEN ((FINAL.VT_ACTUAL_ETD IS NOT NULL AND  FINAL.VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01'))
            AND (FINAL.VT_ACTUAL_ETA IS NOT NULL AND  FINAL.VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')))
            THEN
        (FINAL.VT_ACTUAL_ETA - FINAL.VT_ACTUAL_ETD) ELSE NULL END AS TRANSIT_TIME,
        CASE WHEN ((FINAL.VT_SI_SUB_DATE IS NOT NULL AND  FINAL.VT_SI_SUB_DATE NOT IN ('1900-01-01', '0001-01-01'))
            AND (FINAL.VT_ACTUAL_ETD IS NOT NULL AND  FINAL.VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01')))
            THEN   FINAL.VT_SI_SUB_DATE - FINAL.VT_ACTUAL_ETD ELSE NULL END AS DAYS_BW_ETD_DOCSUB,
        CASE
            WHEN FINAL.VT_SI_SUB_DATE NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_SI_SUB_DATE
            ELSE NULL
        END AS FINAL_VT_SI_SUB_DATE,
            
        CASE WHEN ((FINAL_VT_SI_SUB_DATE IS NOT NULL AND  FINAL_VT_SI_SUB_DATE NOT IN ('1900-01-01', '0001-01-01'))
            AND (FINAL.SI_POSTING_DATE IS NOT NULL AND  FINAL.SI_POSTING_DATE NOT IN ('1900-01-01', '0001-01-01')))
            THEN  FINAL.SI_POSTING_DATE - FINAL_VT_SI_SUB_DATE ELSE NULL END AS DAYS_BW_DOCSUB_CI,

        CASE
            WHEN FINAL.VT_REQUESTED_ETA NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_REQUESTED_ETA
            ELSE NULL
        END AS FINAL_VT_REQUESTED_ETA,

        CASE
            WHEN FINAL.VT_DU_EXPIRY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_DU_EXPIRY_DATE
            ELSE NULL
        END AS FINAL_VT_DU_EXPIRY_DATE,
        CASE WHEN ((FINAL.VT_DU_EXPIRY_DATE IS NOT NULL AND  FINAL.VT_DU_EXPIRY_DATE NOT IN ('1900-01-01', '0001-01-01'))
            AND (FINAL.VT_ACTUAL_ETA IS NOT NULL AND  FINAL.VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')))
            THEN (FINAL.VT_DU_EXPIRY_DATE - FINAL.VT_ACTUAL_ETA)
            ELSE NULL END AS "DU LIFE",
         CASE
                WHEN REGEXP_REPLACE(
                    TRIM(VT_DULICENSE_NUMBER),
                    '^[^A-Za-z0-9]+|[^A-Za-z0-9]+$',
                    ''
                ) RLIKE '^[0-9]+$'
                AND REGEXP_REPLACE(
                    TRIM(VT_DULICENSE_NUMBER),
                    '^[^A-Za-z0-9]+|[^A-Za-z0-9]+$',
                    ''
                ) != '0' THEN 'Available'
                ELSE 'Not Available'
            END AS VT_DU_STATUS_ORIG,
            CASE
                WHEN NULLIF(TRIM(VT_DULICENSE_NUMBER), '') IS NULL THEN 'Not Available'
                ELSE 'Available'
            END AS VT_DU_STATUS,
        CASE
            WHEN FINAL.VT_GRN_DATE NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_GRN_DATE
            ELSE NULL
        END AS FINAL_VT_GRN_DATE,

        --Sales Invoice Value,
        CASE WHEN YEAR(CSH_costingsheet_date) < 2025 
        OR (FINAL_VT_GRN_DATE IS NOT NULL OR FINAL_VT_GRN_DATE NOT IN ('1900-01-01','0001-01-01')) THEN 'No'
        WHEN YEAR(CSH_costingsheet_date) >= 2025 AND ( FINAL_VT_GRN_DATE IS NULL  OR FINAL_VT_GRN_DATE IN ('1900-01-01','0001-01-01')) THEN 'Yes'
        END AS SPR_ACTIVE_FLAG, -- Revalidated
     
        CASE
            WHEN FINAL.VT_BL_DATE NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_BL_DATE
            ELSE NULL
        END AS FINAL_VT_BL_DATE,
        CASE
            /* Level 6 – Arrived */
            WHEN  (
                     (
                            FINAL_VT_ACTUAL_ETA >= '2025-12-15'
                            AND VT_DISCHARGED_AT_POD = 'Yes'
                      )
                      OR
                (
                	FINAL_VT_ACTUAL_ETA < '2025-12-15'
                	AND 
                (  FINAL_VT_ACTUAL_ETA IS NOT NULL            
                   AND FINAL_VT_ACTUAL_ETA <= CURRENT_DATE()
                   AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')
                )                   
                )
                OR 
                FINAL_VT_GRN_DATE IS NOT NULL  
                )    
            THEN 'Arrived'
            /* Level 5 – Shipped */
            WHEN (
                (
            FINAL_VT_ACTUAL_ETD >= '2025-11-01'
            AND REQUEST_FOR_INSPECTION_FLAG = 'Yes'
        )
        OR
            (
             FINAL_VT_ACTUAL_ETD < '2025-11-01'
             AND
            ((
                FINAL_VT_ACTUAL_ETD IS NOT NULL
                AND FINAL_VT_ACTUAL_ETD <= CURRENT_DATE()
                AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01')
            ) -- OR (GP_ATD IS NOT NULL AND GP_ATD <= CURRENT_DATE() AND GP_ATD NOT IN ('1900-01-01','0001-01-01')  )
            OR (
                FINAL_VT_ACTUAL_ETD IS NULL
                AND FINAL_VT_BL_DATE IS NOT NULL
                AND FINAL_VT_BL_DATE <= CURRENT_DATE()
                AND FINAL_VT_BL_DATE NOT IN ('1900-01-01', '0001-01-01')
            ))
            )
            )
            THEN 'Shipped'
            /* Level 4 – Booked */
            WHEN   (
        NULLIF(TRIM(VT_BOOKING_REFERENCE_NUMBER), '') IS NOT NULL
        OR NULLIF(TRIM(VT_BL_NUMBER), '') IS NOT NULL
    ) --AND UPPER(VT_BOOKING_REFERENCE_NUMBER) NOT IN ('NA','N/A') 
            THEN 'Booked'
            /* Level 3 – Ready */
            WHEN FINAL_VT_CARGO_READY_DATE IS NOT NULL
            AND FINAL_VT_CARGO_READY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN 'Ready'
            /* Level 2 – Not Ready */
            WHEN FINAL_PO_NUMBER IS NOT NULL
            AND (
                FINAL_VT_CARGO_READY_DATE IS NULL
                OR FINAL_VT_CARGO_READY_DATE IN ('1900-01-01', '0001-01-01')
            ) THEN 'Not Ready'
            /* Level 1 – Order Processed */
            WHEN NULLIF(CSH_BC_COSTINGSHEET_NUMBER,'') IS NOT NULL THEN 'Order Processed'
            /* Level 0 – New Order */
            WHEN NULLIF(SPRH_BC_REQUESTNO,'') IS NOT NULL THEN 'New Order'
            ELSE 'Uncategorized'
        END AS Operational_status,
                CASE
            /* Level 7 – Arrived */
            WHEN
                 (
                     (
                          FINAL_VT_ACTUAL_ETA >= '2025-12-15'
                          AND VT_DISCHARGED_AT_POD = 'Yes'
                      )
                OR
                (
                	FINAL_VT_ACTUAL_ETA < '2025-12-15'
                	AND 
                (  FINAL_VT_ACTUAL_ETA IS NOT NULL            
                   AND FINAL_VT_ACTUAL_ETA <= CURRENT_DATE()
                   AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')
                )  
                   )
                   OR 
                FINAL_VT_GRN_DATE IS NOT NULL  
                )            
            THEN 7
            /* Level 6 – Shipped */
            WHEN (
                (
            FINAL_VT_ACTUAL_ETD >= '2025-11-01'
            AND REQUEST_FOR_INSPECTION_FLAG = 'Yes'
        )
        OR
            (
             FINAL_VT_ACTUAL_ETD < '2025-11-01'
             AND
            ((
                FINAL_VT_ACTUAL_ETD IS NOT NULL
                AND FINAL_VT_ACTUAL_ETD <= CURRENT_DATE()
                AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01')
            ) -- OR (GP_ATD IS NOT NULL AND GP_ATD <= CURRENT_DATE() AND GP_ATD NOT IN ('1900-01-01','0001-01-01')  )
            OR (
                FINAL_VT_ACTUAL_ETD IS NULL
                AND FINAL_VT_BL_DATE IS NOT NULL
                AND FINAL_VT_BL_DATE <= CURRENT_DATE()
                AND FINAL_VT_BL_DATE NOT IN ('1900-01-01', '0001-01-01')
            ))
            )
            )
             THEN 6
            /* Level 5 – Booked */
            WHEN   (
        NULLIF(TRIM(VT_BOOKING_REFERENCE_NUMBER), '') IS NOT NULL
        OR NULLIF(TRIM(VT_BL_NUMBER), '') IS NOT NULL
    ) --AND UPPER(VT_BOOKING_REFERENCE_NUMBER) NOT IN ('NA','N/A') 
            THEN 5
            /* Level 4 – Ready */
            WHEN FINAL_VT_CARGO_READY_DATE IS NOT NULL
            AND FINAL_VT_CARGO_READY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN 4
            /* Level 3 – Not Ready */
            WHEN FINAL_PO_NUMBER IS NOT NULL
            AND (
                FINAL_VT_CARGO_READY_DATE IS NULL
                OR FINAL_VT_CARGO_READY_DATE IN ('1900-01-01', '0001-01-01')
            ) THEN 3
            /* Level 2 – Order Processed */
            WHEN NULLIF(CSH_BC_COSTINGSHEET_NUMBER,'') IS NOT NULL THEN 2
            /* Level 1 – New Order */
            WHEN NULLIF(SPRH_BC_REQUESTNO,'') IS NOT NULL THEN 1
            ELSE 0
        END AS Operational_Status_Order,
        COALESCE(NULLIF(CSH_CUST_NAME,''), NULLIF(SPRH_CUSTOMER_NAME,'')) AS FINAL_CUSTOMER_NAME,
        CASE WHEN YEAR(CSH_costingsheet_date) < 2025 
        OR (FINAL_VT_GRN_DATE IS NOT NULL OR FINAL_VT_GRN_DATE NOT IN ('1900-01-01','0001-01-01')) THEN 'Yes'
        WHEN YEAR(CSH_costingsheet_date) >= 2025 AND ( FINAL_VT_GRN_DATE IS NULL  OR FINAL_VT_GRN_DATE IN ('1900-01-01','0001-01-01')) THEN 'No'
        END AS DELIVERY_FLAG,
                CASE
            /* Level 6 – Arrived */
            WHEN (
                     (
                          FINAL_VT_ACTUAL_ETA >= '2025-12-15'
                          AND VT_DISCHARGED_AT_POD = 'Yes'
                      )
                OR
                (
                	FINAL_VT_ACTUAL_ETA < '2025-12-15'
                	AND 
                (  FINAL_VT_ACTUAL_ETA IS NOT NULL            
                   AND FINAL_VT_ACTUAL_ETA <= CURRENT_DATE()
                   AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')
                )  
                   )
                   OR 
                (FINAL_VT_GRN_DATE IS NOT NULL)
			OR
		(YEAR(CSH_COSTINGSHEET_DATE) < 2025)

                )
            THEN 'Arrived'
            /* Level 5 – Shipped */
            WHEN (
                (
            FINAL_VT_ACTUAL_ETD >= '2025-11-01'
            AND REQUEST_FOR_INSPECTION_FLAG = 'Yes'
        )
        OR
            (
             FINAL_VT_ACTUAL_ETD < '2025-11-01'
             AND
            ((
                FINAL_VT_ACTUAL_ETD IS NOT NULL
                AND FINAL_VT_ACTUAL_ETD <= CURRENT_DATE()
                AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01')
            ) -- OR (GP_ATD IS NOT NULL AND GP_ATD <= CURRENT_DATE() AND GP_ATD NOT IN ('1900-01-01','0001-01-01')  )
            OR (
                FINAL_VT_ACTUAL_ETD IS NULL
                AND FINAL_VT_BL_DATE IS NOT NULL
                AND FINAL_VT_BL_DATE <= CURRENT_DATE()
                AND FINAL_VT_BL_DATE NOT IN ('1900-01-01', '0001-01-01')
            ))
            )
            )
            THEN 'Shipped'
            /* Level 4 – Booked */
            WHEN   (
        NULLIF(TRIM(VT_BOOKING_REFERENCE_NUMBER), '') IS NOT NULL
        OR NULLIF(TRIM(VT_BL_NUMBER), '') IS NOT NULL
    )--AND UPPER(VT_BOOKING_REFERENCE_NUMBER) NOT IN ('NA','N/A') 
            THEN 'Booked'
            /* Level 3 – Ready */
            WHEN FINAL_VT_CARGO_READY_DATE IS NOT NULL
            AND FINAL_VT_CARGO_READY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN 'Ready'
            /* Level 2 – Not Ready */
            WHEN FINAL_PO_NUMBER IS NOT NULL
            AND (
                FINAL_VT_CARGO_READY_DATE IS NULL
                OR FINAL_VT_CARGO_READY_DATE IN ('1900-01-01', '0001-01-01')
            ) THEN 'Not Ready'
            /* Level 1 – Order Processed */
            WHEN NULLIF(CSH_BC_COSTINGSHEET_NUMBER,'') IS NOT NULL THEN 'Order Processed'
            /* Level 0 – New Order */
            WHEN NULLIF(SPRH_BC_REQUESTNO,'') IS NOT NULL THEN 'New Order'
            ELSE 'Uncategorized'
        END AS Operational_status_CustomerView,
                        CASE
            /* Level 7 – Arrived */
            WHEN (
                     (
                          FINAL_VT_ACTUAL_ETA >= '2025-12-15'
                          AND VT_DISCHARGED_AT_POD = 'Yes'
                      )
                OR
                (
                	FINAL_VT_ACTUAL_ETA < '2025-12-15'
                	AND 
                (  FINAL_VT_ACTUAL_ETA IS NOT NULL            
                   AND FINAL_VT_ACTUAL_ETA <= CURRENT_DATE()
                   AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01', '0001-01-01')
                )  
                   )
                   OR 
                (FINAL_VT_GRN_DATE IS NOT NULL)
			OR
		(YEAR(CSH_COSTINGSHEET_DATE) < 2025)

                )
            
            THEN 7
            /* Level 6 – Shipped */
            WHEN (
                (
            FINAL_VT_ACTUAL_ETD >= '2025-11-01'
            AND REQUEST_FOR_INSPECTION_FLAG = 'Yes'
        )
        OR
            (
             FINAL_VT_ACTUAL_ETD < '2025-11-01'
             AND
            ((
                FINAL_VT_ACTUAL_ETD IS NOT NULL
                AND FINAL_VT_ACTUAL_ETD <= CURRENT_DATE()
                AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01', '0001-01-01')
            ) -- OR (GP_ATD IS NOT NULL AND GP_ATD <= CURRENT_DATE() AND GP_ATD NOT IN ('1900-01-01','0001-01-01')  )
            OR (
                FINAL_VT_ACTUAL_ETD IS NULL
                AND FINAL_VT_BL_DATE IS NOT NULL
                AND FINAL_VT_BL_DATE <= CURRENT_DATE()
                AND FINAL_VT_BL_DATE NOT IN ('1900-01-01', '0001-01-01')
            ))
            )
            )
             THEN 6
            /* Level 5 – Booked */
            WHEN   (
        NULLIF(TRIM(VT_BOOKING_REFERENCE_NUMBER), '') IS NOT NULL
        OR NULLIF(TRIM(VT_BL_NUMBER), '') IS NOT NULL
    ) --AND UPPER(VT_BOOKING_REFERENCE_NUMBER) NOT IN ('NA','N/A') 
            THEN 5
            /* Level 4 – Ready */
            WHEN FINAL_VT_CARGO_READY_DATE IS NOT NULL
            AND FINAL_VT_CARGO_READY_DATE NOT IN ('1900-01-01', '0001-01-01') THEN 4
            /* Level 3 – Not Ready */
            WHEN FINAL_PO_NUMBER IS NOT NULL
            AND (
                FINAL_VT_CARGO_READY_DATE IS NULL
                OR FINAL_VT_CARGO_READY_DATE IN ('1900-01-01', '0001-01-01')
            ) THEN 3
            /* Level 2 – Order Processed */
            WHEN NULLIF(CSH_BC_COSTINGSHEET_NUMBER,'') IS NOT NULL THEN 2
            /* Level 1 – New Order */
            WHEN NULLIF(SPRH_BC_REQUESTNO,'') IS NOT NULL THEN 1
            ELSE 0
        END AS Operational_Status_Order_CustomerView,
        CASE 
            WHEN 
                FINAL_VT_ACTUAL_ETD IS NOT NULL
                AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01','0001-01-01')
                AND DATEADD(DAY, 2, FINAL_VT_ACTUAL_ETD) <= CURRENT_DATE()   -- ETD + 2 days passed
                AND (REQUEST_FOR_INSPECTION_FLAG IS NULL 
                     OR REQUEST_FOR_INSPECTION_FLAG <> 'Yes')               -- Not shipped
                AND Operational_Status_Order < 6
            THEN 'Yes'
            ELSE 'No'
        END AS ETD_Passed_2Days_NotShipped_Flag, -- Require Refinement
        CASE 
        WHEN FINAL_VT_ACTUAL_ETD IS NOT NULL
             AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01','0001-01-01')
             AND DATEADD(DAY, 6, FINAL_VT_ACTUAL_ETD) <= CURRENT_DATE()   -- ETD + 6 days passed
             AND (POSTED_SALES_H_BC_SI_NO IS NULL 
                  OR TRIM(POSTED_SALES_H_BC_SI_NO) = '')                  -- Invoice not submitted
        THEN 'Yes'
        ELSE 'No'
        END AS ETD_PASSED_6_DAYS_INVOICE_NOT_SUBMITTED_FLAG , -- Require Refinement
        CASE 
            WHEN FINAL_VT_ACTUAL_ETA IS NOT NULL
                 AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')
                 AND DATEADD(DAY, 20, FINAL_VT_ACTUAL_ETA) <= CURRENT_DATE()   -- ETA + 20 days passed
                 AND (FINAL_VT_GRN_DATE IS NULL 
                      OR FINAL_VT_GRN_DATE IN ('1900-01-01','0001-01-01'))     -- GRN not updated
            THEN 'Yes'
            ELSE 'No'
        END AS ETA_PASSED_20_DAYS_GRN_NOT_UPDATED_FLAG,
        CASE 
            WHEN FINAL_VT_ACTUAL_ETD IS NOT NULL
                 AND FINAL_VT_ACTUAL_ETD NOT IN ('1900-01-01','0001-01-01')
                 AND DATEADD(DAY, -1, FINAL_VT_ACTUAL_ETD) = CURRENT_DATE()   -- exactly 1 day before ETD
            THEN 'Yes'
            ELSE 'No'
        END AS ETD_PRIOR_1_DAY_PRE_DEPARTURE_FLAG,
        CASE WHEN "DU LIFE" < 11 AND Operational_Status_Order < 7 THEN 'Yes' ELSE 'No' END AS DU_LIFE_FLAG,
        CASE 
            WHEN FINAL_VT_ACTUAL_ETA IS NOT NULL
                 AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')
                 -- days between today and ETA: 0 to 5 days before
                 AND DATEDIFF('day', CURRENT_DATE(), FINAL_VT_ACTUAL_ETA) BETWEEN 0 AND 5
            THEN 'Yes'
            ELSE 'No'
        END AS ARRIVING_SOON_FLAG,
        CASE
            WHEN FINAL.VT_CUSTOMER_DOC_SENT_DATE  NOT IN ('1900-01-01', '0001-01-01') THEN FINAL.VT_CUSTOMER_DOC_SENT_DATE 
            ELSE NULL
        END AS FINAL_VT_CUSTOMER_DOC_SENT_DATE,
        CASE 
            WHEN FINAL_VT_ACTUAL_ETA IS NOT NULL
                 AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')
                 -- we are between ETA - 12 days and ETA (inclusive)
                 AND CURRENT_DATE() BETWEEN DATEADD(DAY, -12, FINAL_VT_ACTUAL_ETA)
                                       AND FINAL_VT_ACTUAL_ETA
                 -- customer doc not sent
                 AND (
                      FINAL_VT_CUSTOMER_DOC_SENT_DATE IS NULL
                      OR FINAL_VT_CUSTOMER_DOC_SENT_DATE IN ('1900-01-01','0001-01-01')
                 )
            THEN 'Yes'
            ELSE 'No'
        END AS PENDING_CUSTOMER_DOC_12_DAYS_BEFORE_ETA_FLAG,
        CASE 
            WHEN FINAL_VT_SUPPLIER_ETD IS NOT NULL
                 AND FINAL_VT_SUPPLIER_ETD NOT IN ('1900-01-01','0001-01-01')
                 AND FINAL_VT_SUPPLIER_ETD < CURRENT_DATE()                
                 AND (
                        (FINAL_VT_CARGO_READY_DATE IS NULL
                         OR FINAL_VT_CARGO_READY_DATE IN ('1900-01-01','0001-01-01'))
                     AND
                        (VT_BOOKING_REFERENCE_NUMBER IS NULL
                         OR TRIM(VT_BOOKING_REFERENCE_NUMBER) = '')
                     )
                AND Operational_Status_Order < 7
            THEN 'Yes'
            ELSE 'No'
        END AS PAST_SUPPLIER_ETD_DATE_FLAG,
        CASE 
            WHEN Operational_Status_Order IN (5,6)                  
                 AND (
                        VT_DULICENSE_NUMBER IS NULL
                        OR TRIM(VT_DULICENSE_NUMBER) = ''
                     )
            THEN 'Yes'
            ELSE 'No'
        END AS PENDING_DU_FLAG,
                CASE
            WHEN VT_BOOKING_DATE  NOT IN ('1900-01-01', '0001-01-01') THEN VT_BOOKING_DATE 
            ELSE NULL
        END AS FINAL_VT_BOOKING_DATE,
        CASE 
            WHEN 
                VT_BOOKING_REFERENCE_NUMBER IS NOT NULL
                AND TRIM(VT_BOOKING_REFERENCE_NUMBER) <> ''
        
                AND (
                    FINAL_PO_NUMBER IS NULL
                    OR TRIM(FINAL_PO_NUMBER) = ''
                )
            THEN 'Yes'
            ELSE 'No'
        END AS PENDING_PO_CREATION_FLAG,
                CASE 
                    WHEN Operational_Status_Order < 7
                        AND
                        (FINAL_VT_REQUESTED_ETA IS NULL
                         OR FINAL_VT_REQUESTED_ETA IN ('1900-01-01','0001-01-01'))
                    THEN 'Yes'
                    ELSE 'No'
                END AS MISSING_REQUESTED_ETA_FLAG,

            CASE 
                WHEN FINAL_VT_REQUESTED_ETA IS NULL
                     OR FINAL_VT_ACTUAL_ETA IS NULL
                     OR FINAL_VT_REQUESTED_ETA IN ('1900-01-01','0001-01-01')
                     OR FINAL_VT_ACTUAL_ETA IN ('1900-01-01','0001-01-01')
                THEN NULL
                ELSE DATEDIFF(
                        'day',
                        FINAL_VT_REQUESTED_ETA,   -- requested ETA
                        FINAL_VT_ACTUAL_ETA      -- actual ETA
                     )
            END AS ETA_Delay_Days,
            CASE
                WHEN ETA_Delay_Days > 0 THEN 'Delayed'
                WHEN ETA_Delay_Days = 0 THEN 'On Time'
                WHEN ETA_Delay_Days < 0 THEN 'Early'
                ELSE 'NA'
            END AS ETA_Performance_Flag,
        CASE
            WHEN VT_CUSTOMER_DOC_RCV_DATE  NOT IN ('1900-01-01', '0001-01-01') THEN VT_CUSTOMER_DOC_RCV_DATE 
            ELSE NULL
        END AS FINAL_VT_CUSTOMER_DOC_RCV_DATE,
        CASE
            WHEN VT_DRAFTAPDATE  NOT IN ('1900-01-01', '0001-01-01') THEN VT_DRAFTAPDATE 
            ELSE NULL
        END AS FINAL_VT_DRAFTAPDATE,
        ARRAY_TO_STRING(
          ARRAY_SLICE(
            ARRAY_CONSTRUCT(
              CSH_BC_COSTINGSHEET_NUMBER,
              IFF(MPR IS NOT NULL AND TRIM(MPR) <> '', TRIM(MPR), ''),
              IFF(VT_BC_CUSTOMER_PO_NUMBER IS NOT NULL AND TRIM(VT_BC_CUSTOMER_PO_NUMBER) <> '', TRIM(VT_BC_CUSTOMER_PO_NUMBER), ''),
              IFF(VT_DULICENSE_NUMBER IS NOT NULL AND TRIM(VT_DULICENSE_NUMBER) <> '', TRIM(VT_DULICENSE_NUMBER), '')
            ),
            0,
            CASE
              WHEN VT_DULICENSE_NUMBER IS NOT NULL AND TRIM(VT_DULICENSE_NUMBER) <> '' THEN 4
              WHEN VT_BC_CUSTOMER_PO_NUMBER IS NOT NULL AND TRIM(VT_BC_CUSTOMER_PO_NUMBER) <> '' THEN 3
              WHEN MPR IS NOT NULL AND TRIM(MPR) <> '' THEN 2
              ELSE 1
            END
          ),
          ' | '
        ) AS CS_MPR_MPO,
    CASE
        WHEN (VT_BOOKING_REFERENCE_NUMBER IS NULL OR TRIM(VT_BOOKING_REFERENCE_NUMBER) = '')
         AND (VT_BL_NUMBER IS NULL OR TRIM(VT_BL_NUMBER) = '') THEN NULL
    
        WHEN (TRIM(VT_BOOKING_REFERENCE_NUMBER) <> '' AND TRIM(VT_BL_NUMBER) <> '') THEN
            VT_BOOKING_REFERENCE_NUMBER || ' | ' || VT_BL_NUMBER
    
        WHEN TRIM(VT_BOOKING_REFERENCE_NUMBER) <> '' THEN 
            VT_BOOKING_REFERENCE_NUMBER
    
        WHEN TRIM(VT_BL_NUMBER) <> '' THEN 
            VT_BL_NUMBER
    END AS BOOKING_BL,
        CASE 
            WHEN 
                FINAL_VT_ACTUAL_ETA IS NOT NULL
                AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')
                AND DATEADD(DAY, 1, FINAL_VT_ACTUAL_ETA) <= CURRENT_DATE()   -- ETA + 1 days passed
                AND (VT_DISCHARGED_AT_POD IS NULL 
                     OR VT_DISCHARGED_AT_POD <> 'Yes')               -- Not arrived
                AND Operational_Status_Order < 7
            THEN 'Yes'
            ELSE 'No'
        END AS ETA_Passed_1Day_NotArrived_Flag,
        CONCAT(CSH_BC_CUSTOMER_ID, ' | ', UPPER(CSH_SOURCE)) AS CUSTID_SOURCE
       
    FROM FINAL )
--SELECT * FROM CUST;
, TCC AS (
    
    SELECT * FROM CUST WHERE (CSH_CS_STAGE <>'Cancelled' OR CSH_CS_STAGE IS NULL) --3585 rows
    AND  NOT ( CSH_BC_COSTINGSHEET_NUMBER = 'CS-WE01954' AND CSH_BC_CUSTOMER_PR_NUMBER = 'LUA-PRN-250436' ) -- 3584 rows
    OR CSH_BC_COSTINGSHEET_NUMBER IS NULL
    OR CSH_BC_CUSTOMER_PR_NUMBER IS NULL
    )
SELECT 
    TCC.*,
    FINAL_LC.LC_UNIQUE_ID AS EXP_LC_UNIQUE_ID,
    FINAL_LC.LC_NO AS EXP_LC_NO,
    FINAL_LC.LINK_PFS AS EXP_LINK_PFS,
    FINAL_LC.LC_CS_ID AS EXP_LC_CS_ID,
    FINAL_LC.LC_TYPE AS EXP_LC_TYPE,
    FINAL_LC.LC_DOCUMENTARY_CREDIT_NO AS EXP_LC_DOCUMENTARY_CREDIT_NO,
    FINAL_LC.LC_DATE_OF_ISSUE AS EXP_LC_DATE_OF_ISSUE,
    FINAL_LC.LC_PLACE_OF_EXPIRY AS EXP_LC_PLACE_OF_EXPIRY,
    FINAL_LC.LC_DATE_OF_EXPIRY AS EXP_LC_DATE_OF_EXPIRY,
    FINAL_LC.LC_ISSUED_BY_ISSUED_TO AS EXP_LC_ISSUED_BY_ISSUED_TO,
    FINAL_LC.LC_CUST_VEND_NAME AS EXP_LC_CUST_VEND_NAME,
    FINAL_LC.LC_CURRENCY AS EXP_LC_CURRENCY,
    FINAL_LC.LC_AMOUNT AS EXP_LC_AMOUNT,
    FINAL_LC.LC_PAYMENT_TERMS AS EXP_LC_PAYMENT_TERMS,
    FINAL_LC.LC_PAYMENT_TERMS_DESCRIPTION AS EXP_LC_PAYMENT_TERMS_DESCRIPTION,
    FINAL_LC.LC_PRODUCT_DESCRIPTION AS EXP_LC_PRODUCT_DESCRIPTION,
    FINAL_LC.LC_CONFIRMATION AS EXP_LC_CONFIRMATION,
    FINAL_LC.LC_DOCUMENT_STATUS AS EXP_LC_DOCUMENT_STATUS,
    FINAL_LC.LC_INITIAL_VALUE AS EXP_LC_INITIAL_VALUE,
    FINAL_LC.LC_SOURCE AS EXP_LC_SOURCE,

    CASE 
        WHEN 
            -- LC must be filled
            /*LC_NO IS NOT NULL
            AND TRIM(LC_NO) <> ''*/
    
            -- Only check ETA records after / from 1st Nov 2025
            FINAL_VT_ACTUAL_ETA >= '2025-11-01'
            AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')

            AND (
            FINAL_VT_DRAFTAPDATE IS NULL
            OR FINAL_VT_DRAFTAPDATE IN ('1900-01-01','0001-01-01')
                )
    
            -- Customer docs still missing
            AND (
                FINAL_VT_CUSTOMER_DOC_RCV_DATE IS NULL 
                OR FINAL_VT_CUSTOMER_DOC_RCV_DATE IN ('1900-01-01','0001-01-01')
            )
    
            -- 12+ days have passed since ETA
            AND DATEDIFF('day', FINAL_VT_ACTUAL_ETA, CURRENT_DATE()) > 12
        THEN 'Yes'
        ELSE 'No'
    END AS LC_CUSTOMER_DOC_MISSING_GT12_FLAG,
    CASE 
    WHEN 
        -- LC must be filled
            LC_NO IS NOT NULL
            AND TRIM(LC_NO) <> ''

        AND FINAL_VT_CUSTOMER_DOC_RCV_DATE >= '2025-11-01'
 
        -- Customer docs received (valid date)
        AND FINAL_VT_CUSTOMER_DOC_RCV_DATE IS NOT NULL
        AND FINAL_VT_CUSTOMER_DOC_RCV_DATE NOT IN ('1900-01-01','0001-01-01')

        -- Draft AP date NOT filled
        AND (
            FINAL_VT_DRAFTAPDATE IS NULL
            OR FINAL_VT_DRAFTAPDATE IN ('1900-01-01','0001-01-01')
        )
    THEN 'Yes'
    ELSE 'No'
END AS LC_NOT_SUBMITTED_TO_FINANCE_FLAG,
CASE 
    ------------------------------------------------------------------
    -- 1) LC not filled → NA / Not Yet
    ------------------------------------------------------------------
    WHEN LC_NO IS NULL
         OR TRIM(LC_NO) = ''
    THEN 'NA / Not Yet'

    ------------------------------------------------------------------
    -- 2) No Pending Action (highest priority for completed cases)
    --    If Draft AP is filled, we consider it done even if doc rcv date is missing
    --    OR old ETA case
    ------------------------------------------------------------------
    WHEN LC_NO IS NOT NULL
         AND TRIM(LC_NO) <> ''
         AND (
                (FINAL_VT_DRAFTAPDATE IS NOT NULL
                 AND FINAL_VT_DRAFTAPDATE NOT IN ('1900-01-01','0001-01-01'))
             OR 
                (FINAL_VT_ACTUAL_ETA < '2025-11-01'
                 AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01'))
             )
    THEN 'No Pending Action'

    ------------------------------------------------------------------
    -- 3) Pending On Operations
    --    Docs received (after 1 Nov 2025) but Draft AP missing
    ------------------------------------------------------------------
    WHEN LC_NO IS NOT NULL
         AND TRIM(LC_NO) <> ''

         AND FINAL_VT_CUSTOMER_DOC_RCV_DATE IS NOT NULL
         AND FINAL_VT_CUSTOMER_DOC_RCV_DATE NOT IN ('1900-01-01','0001-01-01')
         AND FINAL_VT_CUSTOMER_DOC_RCV_DATE >= '2025-11-01'

         AND (
              FINAL_VT_DRAFTAPDATE IS NULL
              OR FINAL_VT_DRAFTAPDATE IN ('1900-01-01','0001-01-01')
         )
    THEN 'Pending On Operations'

    ------------------------------------------------------------------
    -- 4) Waiting Vendor Docs
    --    ETA after 1 Nov 2025 and Customer doc missing
    --    (and Draft AP is NOT filled, otherwise it would have matched No Pending Action)
    ------------------------------------------------------------------
    WHEN LC_NO IS NOT NULL
         AND TRIM(LC_NO) <> ''

         AND FINAL_VT_ACTUAL_ETA >= '2025-11-01'
         AND FINAL_VT_ACTUAL_ETA NOT IN ('1900-01-01','0001-01-01')

         AND (
              FINAL_VT_CUSTOMER_DOC_RCV_DATE IS NULL
              OR FINAL_VT_CUSTOMER_DOC_RCV_DATE IN ('1900-01-01','0001-01-01')
         )

         AND (
              FINAL_VT_DRAFTAPDATE IS NULL
              OR FINAL_VT_DRAFTAPDATE IN ('1900-01-01','0001-01-01')
         )
    THEN 'Waiting Vendor Docs'
END AS LC_DOC_OPS_STATUS
FROM
TCC LEFT JOIN FINAL_LC ON CSH_BC_COSTINGSHEET_NUMBER = LC_CS_ID AND LC_SOURCE=CSH_SOURCE AND LC_TYPE= 'Export'
    ;
